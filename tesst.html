<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ø¹Ø¯Ø© (ÙˆÙŠØ¨)</title>
  <style>
    :root {
      --bg: #0f172a;            /* slate-900 */
      --card: #111827;          /* gray-900 */
      --muted: #94a3b8;         /* slate-400 */
      --text: #e5e7eb;          /* gray-200 */
      --accent: #22c55e;        /* green-500 */
      --accent-2: #06b6d4;      /* cyan-500 */
      --danger: #ef4444;        /* red-500 */
      --border: #1f2937;        /* gray-800 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
      background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
      color: var(--text);
      min-height: 100vh;
    }
    header { position: sticky; top: 0; z-index: 10; background: rgba(17,24,39,.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .title { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 20px; }
    .title .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--accent-2); box-shadow: 0 0 12px var(--accent-2); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 380px 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h3 { margin: 0 0 12px; font-size: 16px; color: #cbd5e1; }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    select, input[type="text"], button, textarea {
      border-radius: 12px; border: 1px solid var(--border); background: #0b1220; color: var(--text);
      padding: 10px 12px; font-size: 14px; outline: none; width: 100%;
    }
    select:focus, input:focus, textarea:focus { border-color: var(--accent-2); box-shadow: 0 0 0 3px rgba(6,182,212,.15); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn { cursor: pointer; font-weight: 700; transition: transform .08s ease, opacity .2s ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(135deg, var(--accent-2), #0ea5e9); border: none; }
    .btn-success { background: linear-gradient(135deg, #16a34a, #22c55e); border: none; }
    .btn-outline { background: transparent; border: 1px dashed var(--muted); color: var(--muted); }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; }
    thead th { background: #0b1220; position: sticky; top: 0; z-index: 1; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 12px; font-size: 14px; text-align: right; }
    tbody tr:hover { background: rgba(6,182,212,.05); }

    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: #a7f3d0; background: rgba(16,185,129,.08) }
    .muted { color: var(--muted); font-size: 12px; }

    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      background: #0b1220; border: 1px solid var(--border); color: var(--text);
      padding: 10px 14px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.3); display: none;
    }

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:520px;width:92%;padding:16px;box-shadow:0 15px 50px rgba(0,0,0,.5)}
    .modal h4{margin:0 0 12px;color:#cbd5e1}
    .modal .row{grid-template-columns:1fr 1fr}
    .modal .actions{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
    .modal .actions .right{margin-inline-start:auto}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <span class="dot"></span>
        ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª (ÙˆÙŠØ¨)
        <span class="muted">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙˆØ§Ù„ØµØ§Ù„Ø© Ø«Ù… Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø±ØªØ¨</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
      <section class="card">
        <h3>Ø§Ù„Ù…Ù„Ø®Øµ Ùˆ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h3>

        <div class="row">
          <div>
            <label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label>
            <select id="shiftSelect">
              <option value="Ø§">Ø§</option>
              <option value="Ø¨">Ø¨</option>
              <option value="Ø¬">Ø¬</option>
              <option value="Ø¯">Ø¯</option>
            </select>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„ØµØ§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="hallSelect">
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="toolbar">
          <button class="btn btn-outline" id="btnOfficers">ğŸ“‹ Ø¹Ø±Ø¶ Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¶Ø¨Ø§Ø·</button>
          <button class="btn btn-outline" id="btnBack">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
          <button class="btn btn-primary" id="btnShow">Ø¹Ø±Ø¶</button>
          <button class="btn btn-success" id="btnSaveGit">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
          <button class="btn btn-outline" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù</button>
          <input type="file" id="filePicker" accept="application/json" style="display:none" />
          <button class="btn btn-outline" id="btnGhSettings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub</button>
          <button class="btn btn-outline" id="btnReload">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
          <span class="muted" style="margin-inline-start:auto" id="stats"></span>
        </div>
      </section>

      <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
      <section class="card">
        <div class="toolbar" style="justify-content:space-between; margin-bottom:10px">
          <h3 style="margin:0">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
          <span class="pill" id="badge"></span>
        </div>

        <div class="row">
          <div>
            <label>Ø¨Ø­Ø«</label>
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±ØªØ¨Ø©â€¦" />
          </div>
          <div></div>
        </div>
        <div style="height:8px"></div>

        <div style="overflow:auto; max-height:60vh;">
          <table>
            <thead>
              <tr id="theadRow">
                <th style="width:52px">#</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th style="width:160px">Ø§Ù„Ø±ØªØ¨Ø©</th>
                <th style="width:240px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div style="height:10px"></div>
        <div class="toolbar">
          <button class="btn" id="btnAdd" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa); border:none;">+ Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…</button>
          <button class="btn btn-outline" id="btnClearHall">Ø­Ø°Ù ÙƒÙ„ ØµÙÙˆÙ Ø§Ù„ØµØ§Ù„Ø©</button>
          <span class="muted" style="margin-inline-start:auto" id="listStats"></span>
        </div>
      </section>
    
    <!-- Ù†Ø§ÙØ°Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
    <div class="modal-backdrop" id="transferBackdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h4>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</h4>
        <div class="row">
          <div style="grid-column:1/-1">
            <div id="transferTargetName" class="muted"></div>
          </div>
          <div>
            <label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ù‡Ø¯Ù</label>
            <select id="targetShift">
              <option value="Ø§">Ø§</option>
              <option value="Ø¨">Ø¨</option>
              <option value="Ø¬">Ø¬</option>
              <option value="Ø¯">Ø¯</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù‡Ø¯Ù</label>
            <select id="targetHall"></select>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-outline" id="transferCancel">Ø¥Ù„ØºØ§Ø¡</button>
          <span class="right"></span>
          <button class="btn btn-success" id="transferOk">ØªØ­ÙˆÙŠÙ„</button>
        </div>
      </div>
    </div>
</div>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub -->
  <div class="modal-backdrop" id="ghBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h4>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub</h4>
      <div class="row">
        <div>
          <label>Owner</label>
          <input type="text" id="ghOwner" />
        </div>
        <div>
          <label>Repo</label>
          <input type="text" id="ghRepo" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Branch</label>
          <input type="text" id="ghBranch" />
        </div>
        <div>
          <label>Path</label>
          <input type="text" id="ghPath" />
        </div>
      </div>
      <div class="row">
        <div style="grid-column:1/-1">
          <label>Personal Access Token</label>
          <input type="password" id="ghToken" placeholder="ghp_..." />
          <div class="muted">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-outline" id="ghCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <span class="right"></span>
        <button class="btn btn-success" id="ghSave">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    "use strict";

    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // Ø¹Ù†Ø§ØµØ± DOM
    const rowsEl   = $('#rows');
    const shiftSel = $('#shiftSelect');
    const hallSel  = $('#hallSelect');
    const badgeEl  = $('#badge');
    const btnBack  = $('#btnBack');
    const transferBackdrop = $('#transferBackdrop');
    const targetShift = $('#targetShift');
    const targetHall  = $('#targetHall');
    const transferTargetName = $('#transferTargetName');
    const searchEl = $('#searchInput');
    const statsEl  = $('#stats');
    const listStatsEl = $('#listStats');
    const theadRow = $('#theadRow');
    const btnOfficers = $('#btnOfficers');

    // ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶: main = Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©/Ø§Ù„ØµØ§Ù„Ø©ØŒ officers = Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø§Ø·
    let MODE = 'main';

    // Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    let DB = {};
    const REMOTE_URL = 'https://raw.githubusercontent.com/saud5161/Special-document/main/name.json';

    function toast(msg, ok=true){
      const el = $('#toast');
      el.style.display = 'block';
      el.style.borderColor = ok? 'var(--accent)': 'var(--danger)';
      el.style.color = ok? '#d1fae5': '#fecaca';
      el.textContent = msg;
      clearTimeout(el.__t);
      el.__t = setTimeout(()=>{ el.style.display = 'none'; }, 2200);
    }

    function recalcHalls(){
      const shift = shiftSel.value;
      const halls = DB?.[shift] ? Object.keys(DB[shift]).sort((a,b)=>Number(a)-Number(b)) : [];
      hallSel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>' + halls.map(h=>`<option value="${h}">${h}</option>`).join('');
    }

    function getActiveList(){
      if(MODE === 'officers'){
        DB.officers ??= [];
        return DB.officers;
      }
      const shift = shiftSel.value;
      const hall  = String(hallSel.value || '').trim();
      DB[shift] ??= {};
      if(!hall){
        const all = [];
        Object.keys(DB[shift]).forEach(h=>{
          (DB[shift][h]||[]).forEach((rec,idx)=>{
            all.push(Object.assign({__srcHall:h, __srcIndex:idx}, rec));
          });
        });
        return all;
      }
      DB[shift][hall] ??= [];
      return DB[shift][hall];
    }

    function renderStats(){
      const list = getActiveList();
      const dirty = list.filter(r=>r.__dirty).length;
      statsEl.textContent = `${list.length} ØµÙ${list.length!==1?'ÙˆÙ':''} â€” ${dirty} ØºÙŠØ± Ù…Ø­ÙÙˆØ¸`;
      listStatsEl.textContent = dirty ? 'Ù‡Ù†Ø§Ùƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©' : '';
    }

    function render(){
      const list = getActiveList();
      const q = (searchEl.value||'').trim();
      const filtered = !q ? list : list.filter(r => (r.name||'').includes(q) || (r.rank||'').includes(q));

      // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªØºÙŠØ± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¶Ø¨Ø§Ø· Ù„Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµØ§Ù„Ø©/Ø§Ù„ØªØ­ÙˆÙŠÙ„
      theadRow.innerHTML = (MODE==='officers')
        ? `<th style="width:52px">#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th style="width:160px">Ø§Ù„Ø±ØªØ¨Ø©</th><th style="width:240px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>`
        : `<th style="width:52px">#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th style="width:160px">Ø§Ù„Ø±ØªØ¨Ø©</th><th style="width:240px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>`;

      rowsEl.innerHTML = '';
      filtered.forEach((rec, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="muted">${idx+1}</td>
          <td><input type="text" class="in in-name" value="${rec.name||''}" /></td>
          <td><input type="text" class="in in-rank" value="${rec.rank||''}" /></td>
          <td>
            <div class="toolbar">
              <button class="btn btn-success btn-save">Ø­ÙØ¸</button>
              ${MODE==='officers' ? '' : '<button class="btn btn-outline btn-transfer">ØªØ­ÙˆÙŠÙ„</button>'}
              <button class="btn btn-outline btn-del">Ø­Ø°Ù</button>
              <span class="muted" style="margin-inline-start:auto">${rec.__dirty? 'Ù…Ø¹Ø¯Ù‘Ù„':''}</span>
            </div>
          </td>`;

        const nameIn   = tr.querySelector('.in-name');
        const rankIn   = tr.querySelector('.in-rank');
        const btnSave  = tr.querySelector('.btn-save');
        const btnDel   = tr.querySelector('.btn-del');
        const btnTransfer = tr.querySelector('.btn-transfer');

        const original = { name: rec.name||'', rank: rec.rank||'' };

        function mark(){
          rec.__dirty = (nameIn.value !== original.name) || (rankIn.value !== original.rank);
          renderStats();
        }
        nameIn.addEventListener('input', mark);
        rankIn.addEventListener('input', mark);

        btnSave.onclick = () => {
          rec.name = nameIn.value.trim();
          rec.rank = rankIn.value.trim();
          rec.__dirty = false;
          render();
        };
        if(btnTransfer){
          btnTransfer.onclick = () => {
            // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„
            transferTargetName.textContent = `Ø§Ù„Ø§Ø³Ù…: ${rec.name||''}`;
            targetShift.value = shiftSel.value;
            const halls = DB?.[targetShift.value] ? Object.keys(DB[targetShift.value]).sort((a,b)=>Number(a)-Number(b)) : [];
            targetHall.innerHTML = halls.map(h=>`<option value="${h}">${h}</option>`).join('') || '<option value="1">1</option>';
            transferBackdrop.style.display = 'flex';
            transferBackdrop.__ctx = { rec, originalShift: shiftSel.value, originalHall: rec.__srcHall || hallSel.value, idx: rec.__srcIndex };
          };
        }
        btnDel.onclick = () => {
          const listRef = getActiveList();
          const realIdx = listRef.indexOf(rec);
          if(realIdx>-1){ listRef.splice(realIdx,1); render(); }
        };

        rowsEl.appendChild(tr);
      });

      badgeEl.textContent = (MODE==='officers')
        ? `Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¶Ø¨Ø§Ø·`
        : `Ù…Ù†Ø§ÙˆØ¨Ø© ${shiftSel.value} â€” ØµØ§Ù„Ø© ${hallSel.value || 'Ø§Ù„ÙƒÙ„'}`;

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
      $('#btnAdd').textContent = MODE==='officers' ? '+ Ø¥Ø¶Ø§ÙØ© Ø¶Ø§Ø¨Ø·' : '+ Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…';
      $('#btnClearHall').textContent = MODE==='officers' ? 'Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¶Ø¨Ø§Ø·' : 'Ø­Ø°Ù ÙƒÙ„ ØµÙÙˆÙ Ø§Ù„ØµØ§Ù„Ø©';
      renderStats();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© (GitHub â†’ fallback Ù„Ø§ Ø´ÙŠØ¡) + Ø¯Ù…Ø¬ officers.json
    async function loadDB(){
      try{
        const r = await fetch(REMOTE_URL, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        DB = await r.json();
        // ØªØ­Ù…ÙŠÙ„ ÙˆØ¯Ù…Ø¬ officers.json Ø¥Ù† ÙˆÙØ¬Ø¯ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
        try{
          const ro = await fetch('https://raw.githubusercontent.com/saud5161/Special-document/main/officers.json', {cache:'no-store'});
          if(ro.ok){
            const off = await ro.json();
            DB.officers ??= [];
            const seen = new Set(DB.officers.map(o=>(o.name||'').trim()));
            off.forEach(o=>{ const nm=(o.name||'').trim(); if(nm && !seen.has(nm)){ DB.officers.push({name:nm, rank:(o.rank||'').trim()}); } });
          }
        }catch(_){ /* ØªØ¬Ø§Ù‡Ù„ */ }
        recalcHalls();
        render();
        toast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù…Ù† GitHub');
      }catch(e){
        console.warn('fetch failed', e);
        DB = { officers: [] };
        recalcHalls();
        render();
        toast('Ù‚Ø§Ø¹Ø¯Ø© ÙØ§Ø±ØºØ© â€” ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub', false);
      }
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    $('#btnImport').onclick = () => { $('#filePicker').click(); };
    $('#filePicker').addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = (e.target && e.target.result) ? e.target.result : '';
          DB = JSON.parse(text) || {};
          DB.officers ??= [];
          recalcHalls(); render();
          toast('âœ” ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù');
        } catch (err) {
          console.error(err);
          toast('âœ– Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ (JSON)', false);
        }
      };
      reader.onerror = (e) => {
        console.error('FileReader error:', e);
        toast('âœ– ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', false);
      };
      reader.readAsText(f, 'utf-8');
    });

    // GitHub Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const GH_DEFAULT = { owner: 'saud5161', repo: 'Special-document', branch: 'main', path: 'name.json' };
    const ghKey = (k)=>`gh_${k}`;
    const ghGet = (k, d='') => localStorage.getItem(ghKey(k)) || d;
    const ghSet = (k, v) => localStorage.setItem(ghKey(k), v||'');

    function getGhCfg(){
      const t = ghGet('token','') || localStorage.getItem('API_TOKEN') || '';
      return {
        owner: ghGet('owner', GH_DEFAULT.owner),
        repo: ghGet('repo', GH_DEFAULT.repo),
        branch: ghGet('branch', GH_DEFAULT.branch),
        path: ghGet('path', GH_DEFAULT.path),
        token: t
      };
    }
    

    function openGhModal(){
      const cfg = getGhCfg();
      $('#ghOwner').value  = cfg.owner;
      $('#ghRepo').value   = cfg.repo;
      $('#ghBranch').value = cfg.branch;
      $('#ghPath').value   = cfg.path;
      $('#ghToken').value  = cfg.token;
      $('#ghBackdrop').style.display = 'flex';
    }
    function closeGhModal(){ $('#ghBackdrop').style.display = 'none'; }

    $('#btnGhSettings').onclick = openGhModal;
    $('#ghCancel').onclick = closeGhModal;
    $('#ghBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='ghBackdrop') closeGhModal(); });
    $('#ghSave').onclick = () => {
      ghSet('owner',  $('#ghOwner').value.trim());
      ghSet('repo',   $('#ghRepo').value.trim());
      ghSet('branch', $('#ghBranch').value.trim());
      ghSet('path',   $('#ghPath').value.trim());
      ghSet('token',  $('#ghToken').value.trim());
      toast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub');
      closeGhModal();
    };

    // Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub (Ù…Ø¹ Ø­ÙØ¸ officers.json Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø£Ùˆ Ø¹Ù„Ù‰ GitHub)
    const toBase64 = (str) => btoa(unescape(encodeURIComponent(str)));

    function doDownload(filename, text){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function saveToGitHub(){
      try{
        if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© (GitHub)ØŸ')) return;
        // Ù†Ø¸Ù‘Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
        const clean = JSON.parse(JSON.stringify(DB));
        (function walk(obj){ if(Array.isArray(obj)) obj.forEach(r=>delete r.__dirty); else if(obj && typeof obj==='object') Object.values(obj).forEach(walk); })(clean);
        const content = JSON.stringify(clean, null, 2);

        const { owner, repo, branch, path, token } = getGhCfg();
        if(!token){
          // ØªÙ†Ø²ÙŠÙ„ Ù…Ø­Ù„ÙŠ Ø¨Ø¯ÙŠÙ„
          doDownload('name.json', content);
          if(Array.isArray(clean.officers)) doDownload('officers.json', JSON.stringify(clean.officers, null, 2));
          toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠØ© Ø¨Ø¯Ù„ Ø§Ù„Ø±ÙØ¹', false);
          return;
        }

        // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ sha Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯) Ù„ØªØ­Ø¯ÙŠØ«Ù‡
        const base = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
        let sha = undefined;
        const infoUrl = `${base}?ref=${encodeURIComponent(branch)}`;
        const commonHeaders = {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`,
          'X-GitHub-Api-Version': '2022-11-28'
        };
        try{
          const infoRes = await fetch(infoUrl, { headers: commonHeaders, cache:'no-store' });
          if(infoRes.ok){
            const js = await infoRes.json();
            sha = js.sha;
          }
        }catch(_){ /* ØªØ¬Ø§Ù‡Ù„ */ }

        const body = {
          message: `Update ${path} via Web UI â€” ${new Date().toISOString()}`,
          content: toBase64(content),
          branch,
          sha
        };

        const putRes = await fetch(base, {
          method:'PUT',
          headers: { ...commonHeaders, 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        if(!putRes.ok){
          const errText = await putRes.text();
          throw new Error(`GitHub API ${putRes.status}: ${errText}`);
        }

        toast('âœ” ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© (GitHub)');
      }catch(e){
        console.error(e);
        toast('âœ– ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub: '+ e.message, false);
      }
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    $('#btnShow').onclick = render;
    $('#btnReload').onclick = loadDB;
    $('#btnSaveGit').onclick = saveToGitHub;
    $('#btnAdd').onclick = () => { getActiveList().push({ name:'', rank:'' }); render(); };
    $('#btnClearHall').onclick = () => {
      const list = getActiveList();
      const label = (MODE==='officers') ? 'ÙƒÙ„ Ø§Ù„Ø¶Ø¨Ø§Ø·' : 'ÙƒÙ„ ØµÙÙˆÙ Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
      if(confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù ${label}. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)){
        list.splice(0, list.length); render();
      }
    };

    shiftSel.addEventListener('change', ()=>{ if(MODE==='main'){ recalcHalls(); render(); } });

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
    const closeTransfer = ()=>{ transferBackdrop.style.display = 'none'; transferBackdrop.__ctx = null; };
    $('#transferCancel').onclick = closeTransfer;
    $('#transferBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='transferBackdrop') closeTransfer(); });
    $('#transferOk').onclick = ()=>{
      const ctx = transferBackdrop.__ctx;
      if(!ctx){ closeTransfer(); return; }
      const destShift = targetShift.value;
      const destHall  = targetHall.value || '1';
      DB[destShift] ??= {};
      DB[destShift][destHall] ??= [];
      DB[destShift][destHall].push({ name: ctx.rec.name||'', rank: ctx.rec.rank||'', __dirty: true });
      if(ctx.originalShift && ctx.originalHall){
        const arr = DB[ctx.originalShift]?.[ctx.originalHall];
        if(Array.isArray(arr)){
          const i = typeof ctx.idx==='number' ? ctx.idx : arr.findIndex(r=>r===ctx.rec || (r.name===ctx.rec.name && r.rank===ctx.rec.rank));
          if(i>-1){ arr.splice(i,1); }
        }
      }
      toast('âœ” ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„'); closeTransfer(); render();
    };

    hallSel.addEventListener('change', ()=>{ if(MODE==='main'){ render(); } });
    searchEl.addEventListener('input', ()=>{ render(); });

    // Ø²Ø± "Ø¹Ø±Ø¶ Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¶Ø¨Ø§Ø·" (ØªØ¨Ø¯ÙŠÙ„)
    btnOfficers.onclick = () => {
      MODE = (MODE === 'officers') ? 'main' : 'officers';
      btnOfficers.textContent = (MODE==='officers') ? 'â†©ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª' : 'ğŸ“‹ Ø¹Ø±Ø¶ Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¶Ø¨Ø§Ø·';
      // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¶Ø¨Ø§Ø· Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø§Ù„ØªØ­ÙˆÙŠÙ„/Ø§Ù„ØµØ§Ù„Ø§Øª
      render();
    };

    btnBack && (btnBack.onclick = ()=>{ history.back(); });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadDB();
  </script>
</body>
</html>
