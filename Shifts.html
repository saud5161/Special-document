<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-body: #0f172a;
      --bg-sidebar: #1e293b;
      --bg-card: #1e293b;
      --primary: #3b82f6;
      --productivity: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --admin: #8b5cf6;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --radius: 12px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font-family: 'Cairo', sans-serif;
      background-color: var(--bg-body); color: var(--text-main);
      height: 100vh; display: flex; overflow: hidden;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .app-container { display: flex; width: 100%; height: 100%; }
    
    .sidebar {
      width: 260px; background: var(--bg-sidebar); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 20px; gap: 10px; flex-shrink: 0; z-index: 50;
      transition: transform 0.3s ease;
    }
    
    .brand { display: flex; align-items: center; gap: 12px; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    .brand-icon { 
        width: 45px; height: 45px; 
        background: transparent; 
        display: grid; place-items: center; 
        border-radius: 50%; overflow: hidden;
    }
    .brand-icon img { width: 100%; height: 100%; object-fit: contain; }
    
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px; position: relative;
      border-radius: var(--radius); color: var(--text-muted); cursor: pointer; transition: all 0.2s;
      font-weight: 600; font-size: 14px;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .nav-item.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-right: 3px solid var(--primary); }
    
    .nav-badge {
        background: var(--danger); color: white; border-radius: 50%; 
        width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center;
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        box-shadow: 0 0 5px var(--danger); animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);} 70% {box-shadow: 0 0 0 5px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }

    .user-info { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border); text-align: center; font-size: 13px; color: var(--productivity); font-weight: bold; margin-bottom: 5px; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .top-header { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid var(--border); background: rgba(15, 23, 42, 0.95); }
    .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #mobileMenuBtn { display: none; position: fixed; top: 15px; right: 15px; z-index: 1001; background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer; align-items: center; justify-content: center; }

    .grid-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
    .form-control { width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 10px; font-family: inherit; font-size: 16px; -webkit-appearance: none; appearance: none; }
    .form-control:focus { border-color: var(--primary); }
    .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }

    .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; width: 100%; }
    .btn-danger { background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn-warning { background: var(--warning); color: #000; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px;}

    .auth-box { width: 350px; background: var(--bg-card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
    .auth-toggle { font-size: 13px; color: var(--primary); cursor: pointer; margin-top: 15px; display: inline-block; }
    .auth-toggle:hover { text-decoration: underline; }

    .status-selector { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
    .radio-label { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 10px 16px; border-radius: 20px; text-align: center; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--text-muted); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px; select-none: none; position: relative; overflow: hidden; }
    .radio-label:has(input:checked) { border-color: transparent; color: white !important; background: var(--primary); transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: pulse-ring 2s infinite; }
    .radio-label[data-type="bad"]:has(input:checked) { background: var(--danger); }
    .radio-label[data-type="good"]:has(input:checked) { background: var(--success); }
    .radio-label input { display: none; }

    .transfer-area { display: flex; gap: 20px; height: 450px; margin-top: 20px; }
    .list-panel { flex: 1; display: flex; flex-direction: column; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
    .panel-header { padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    .list-box { flex: 1; overflow-y: auto; padding: 10px; }
    .list-item { padding: 12px 14px; margin-bottom: 6px; background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
    .list-item:hover { background: rgba(255,255,255,0.06); }
    .list-item.selected { background: rgba(59, 130, 246, 0.15); border: 1px solid var(--primary); }

    .stats-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; position:relative; }
    .score-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
    .score-table th { text-align: right; padding: 15px; color: var(--text-muted); border-bottom: 2px solid var(--border); font-size: 12px; font-weight: bold; background: rgba(0,0,0,0.2); }
    .score-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; vertical-align: middle; }
    .score-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .score-input { width: 100px; text-align: center; padding: 8px; background: var(--bg-body); border: 1px solid var(--border); color: var(--productivity); border-radius: 8px; font-weight: 800; font-size: 16px; -webkit-appearance: none; transition: 0.2s; }
    .score-input:focus { border-color: var(--productivity); box-shadow: 0 0 0 3px rgba(6,182,212,0.15); }

    .gauge-container { width: 100%; max-width: 180px; margin: 0 auto; text-align: center; position: relative; }
    .gauge-svg { width: 100%; height: auto; overflow: visible; }
    .gauge-arc-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 12; stroke-linecap: round; }
    .gauge-arc-val { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dasharray 1s ease-out, stroke 0.5s; }
    .gauge-needle { fill: var(--text-main); transform-origin: 100px 90px; transition: transform 1s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .gauge-center { fill: var(--bg-card); stroke: var(--border); stroke-width: 2; }
    .gauge-text { font-size: 20px; font-weight: bold; fill: var(--text-main); text-anchor: middle; }
    .gauge-reason { font-size: 11px; margin-top: 5px; font-weight: bold; line-height: 1.4; }

    .bar-chart-container { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
    .bar-row { display: grid; grid-template-columns: 180px 1fr 60px; align-items: center; gap: 15px; }
    .bar-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; background: var(--productivity); border-radius: 4px; width: 0; transition: width 1s ease; }
    .bar-fill.rank-1 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .kpi-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 12px; }
    .kpi-val { font-size: 20px; font-weight: 800; margin-top: 5px; word-break: break-word; }
    .kpi-lbl { font-size: 12px; color: var(--text-muted); }

    .breakdown-item { cursor: pointer; transition: 0.2s; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border: 1px solid transparent; }
    .breakdown-item:hover { background: rgba(255,255,255,0.06); border-color: var(--border); }
    .breakdown-details { background: rgba(0,0,0,0.3); margin-top: -5px; border-radius: 0 0 10px 10px; padding: 15px; font-size: 12px; display: none; margin-bottom: 15px; border: 1px solid var(--border); border-top: none; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); }

    .profile-header { background: linear-gradient(to left, var(--bg-card), rgba(6, 182, 212, 0.15)); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .profile-stat-group { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); width: 100%; }
    .mini-stat { text-align: center; }
    .mini-stat .val { font-weight: bold; font-size: 16px; }
    .mini-stat .lbl { font-size: 10px; color: var(--text-muted); }

    .hidden { display: none !important; }

    /* New Styles */
    .instruction-hint {
        font-size: 11px; color: var(--warning); font-weight: 800; margin-bottom: 8px;
        display: flex; align-items: center; gap: 5px; animation: pulse-orange 3s infinite;
    }
    @keyframes pulse-orange { 0% {opacity:0.7;} 50% {opacity:1;} 100% {opacity:0.7;} }
    
    .submitted-section { margin-top: 20px; border-top: 2px dashed var(--border); padding-top: 15px; }
    .submitted-item { background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
    .submitted-item .meta { font-size: 11px; color: var(--text-muted); margin-right: 5px; }

    .discipline-detail-text { font-size: 9px; color: var(--text-muted); margin-top: 3px; display: block; }

    /* Timeline Chart Styles */
    .timeline-wrapper {
        display: flex;
        flex-direction: column;
        height: 250px;
        padding-bottom: 20px;
        overflow-x: auto;
    }
    .timeline-container {
        display: flex;
        align-items: flex-end;
        height: 100%;
        padding: 10px 0;
        gap: 12px;
        min-width: 100%;
    }
    .timeline-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    .timeline-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 150px;
        position: relative;
    }
    .t-bar-total { width: 10px; background: #1e3a8a; border-radius: 2px 2px 0 0; transition: height 0.5s ease; }
    .t-bar-good { width: 10px; background: var(--success); border-radius: 2px 2px 0 0; transition: height 0.5s ease; }
    .t-bar-bad { width: 10px; background: var(--danger); border-radius: 2px 2px 0 0; transition: height 0.5s ease; }
    .timeline-label { font-size: 10px; color: var(--text-muted); margin-top: 5px; transform: rotate(-45deg); white-space: nowrap; }
    .timeline-score { font-size: 9px; font-weight: bold; margin-bottom: 3px; position: absolute; top: -15px; width: 100%; text-align: center; }
    .legend-box { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; font-size: 11px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .dot { width: 10px; height: 10px; border-radius: 2px; }

    /* Toggle Switch */
    .violation-toggle {
        display: flex; gap: 10px; justify-content: center; margin: 10px 0;
    }
    .v-option {
        padding: 5px 12px; border: 1px solid var(--border); border-radius: 20px; font-size: 11px; cursor: pointer;
        opacity: 0.6; transition: 0.2s;
    }
    .v-option.active { opacity: 1; font-weight: bold; border-color: transparent; }
    .v-option[data-val="no"].active { background: var(--success); color: white; }
    .v-option[data-val="yes"].active { background: var(--danger); color: white; }

    .excuse-btn {
        background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; color: #8b5cf6;
        font-size: 11px; padding: 4px 10px; border-radius: 6px; cursor: pointer;
        font-weight: bold; transition: 0.2s;
    }
    .excuse-btn:hover { background: #8b5cf6; color: white; }

    .delete-btn-sm {
        background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger);
        font-size: 12px; padding: 4px 8px; border-radius: 6px; cursor: pointer; margin-right: 8px;
    }
    .delete-btn-sm:hover { background: var(--danger); color: white; }

    /* Record Layout Styles */
    .record-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .doughnut-card { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 200px; }
    .doughnut-container { position: relative; width: 140px; height: 140px; border-radius: 50%; display: grid; place-items: center; }
    .doughnut-hole { width: 100px; height: 100px; background: var(--bg-card); border-radius: 50%; position: absolute; z-index: 2; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
    .doughnut-legend { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; font-size: 10px; }
    .d-leg-item { display: flex; align-items: center; gap: 4px; }
    .d-leg-color { width: 8px; height: 8px; border-radius: 50%; }

    @media (max-width: 768px) {
      .app-container { flex-direction: column; height: 100vh; }
      .top-header { display: none !important; }
      #mobileMenuBtn { display: flex !important; }
      .sidebar { position: fixed; top: 0; right: 0; width: 75%; max-width: 300px; height: 100%; transform: translateX(100%); z-index: 2000; box-shadow: -5px 0 20px rgba(0,0,0,0.5); padding-top: 60px; background: var(--bg-sidebar); align-items: stretch; }
      .sidebar.active { transform: translateX(0); }
      .app-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1500; backdrop-filter: blur(2px); }
      .app-overlay.active { display: block; }
      .sidebar .brand { display: flex; justify-content: center; }
      .sidebar .user-info { display: block; }
      .nav-item { padding: 15px; font-size: 14px; border-radius: 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
      .nav-item span { margin-left: 10px; }
      .content-scroll { padding: 20px; padding-top: 70px; } 
      .transfer-area { flex-direction: column; height: auto !important; }
      .list-panel { height: 300px; flex: none; }
      .radio-label { padding: 12px 18px; font-size: 13px; margin-bottom: 5px; }
      .auth-box { width: 100%; }

      #status_manual_text { padding: 8px; font-size: 13px; height: 40px; }
      .other-input-container { padding-top: 5px !important; margin-top: 5px !important; }
      .record-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div id="authScreen" style="position:fixed; inset:0; background:rgba(15,23,42,0.98); z-index:2500; display:grid; place-items:center; padding: 20px;">
    <div id="loginForm" class="auth-box">
      <h2 style="color:var(--primary); margin-bottom:20px;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <input type="email" id="email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px">
      <input type="password" id="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:10px">
      <button class="btn-primary" onclick="signIn()">Ø¯Ø®ÙˆÙ„</button>
      <div class="auth-toggle" onclick="toggleAuthMode()">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„</div>
      <div id="authMsg" class="text-danger" style="margin-top:10px; font-size:12px; color:var(--danger)"></div>
    </div>
    <div id="registerForm" class="auth-box hidden">
      <h2 style="color:var(--success); margin-bottom:20px;">ğŸ“ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù…</h2>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
          <input type="text" id="reg_rank" class="form-control" placeholder="Ø§Ù„Ø±ØªØ¨Ø©">
          <input type="text" id="reg_name" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…">
      </div>
      <input type="email" id="reg_email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px">
      <input type="password" id="reg_pass" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:10px">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
          <select id="reg_hall" class="form-control">
              <option value="" disabled selected>Ø§Ù„ØµØ§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
              <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
          <select id="reg_shift" class="form-control">
              <option value="" disabled selected>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
              <option value="Ø£">Ø£</option><option value="Ø¨">Ø¨</option><option value="Ø¬">Ø¬</option><option value="Ø¯">Ø¯</option>
          </select>
      </div>
      <select id="reg_type" class="form-control" style="margin-bottom:15px">
          <option value="departure" selected>Ù…ØºØ§Ø¯Ø±Ø©</option>
          <option value="arrival">Ù‚Ø¯ÙˆÙ…</option>
      </select>
      <button class="btn-primary" style="background:var(--success)" onclick="signUp()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn-secondary" onclick="toggleAuthMode()">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <div id="regMsg" class="text-danger" style="margin-top:10px; font-size:12px;"></div>
    </div>
  </div>

  <button id="mobileMenuBtn" onclick="toggleSidebar()">â˜°</button>
  <div id="mobileOverlay" class="app-overlay" onclick="toggleSidebar()"></div>

  <div class="app-container">
    <aside class="sidebar" id="mainSidebar">
      <div class="brand">
        <div class="brand-icon">
            <img src="https://my.gov.sa/files/agency_files/qtrn0va83ei17h9cfkg70eywf1d14fwq.png" alt="Logo">
        </div>
        <div><b>Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</b><div style="font-size:11px;color:var(--text-muted)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</div></div>
      </div>
      <nav style="display:flex; flex-direction:column; gap:5px; width:100%">
        <div class="nav-item active" onclick="go('daily')" id="nav-daily"><span>ğŸ“</span> Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        <div class="nav-item" onclick="go('monthly')" id="nav-monthly"><span>âœˆï¸</span> Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ†</div>
        <div class="nav-item" onclick="go('record')" id="nav-record"><span>ğŸ‘¤</span> Ø³Ø¬Ù„ Ø§Ù„ÙØ±Ø¯</div>
        <div class="nav-item" onclick="go('stats')" id="nav-stats"><span>ğŸ“Š</span> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
        <div class="nav-item" onclick="go('manage')" id="nav-manage"><span>âš™ï¸</span> Ù†Ù‚Ù„ / ØªØ¹Ø¯ÙŠÙ„</div>
        <div class="nav-item hidden" onclick="go('requests')" id="nav-requests" style="border-color:var(--warning); color:var(--warning)">
            <span>ğŸ””</span> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
            <div id="reqBadge" class="nav-badge hidden"></div>
        </div>
      </nav>
      <div class="user-info" id="userDisplayName"></div>
      <button class="btn-secondary" onclick="logout()" style="margin:20px">Ø®Ø±ÙˆØ¬</button>
    </aside>

    <main class="main-content">
      <header class="top-header">
        <div style="font-weight:800; font-size:18px" id="pageTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</div>
        <div style="font-size:13px; color:var(--productivity)" id="dateNow"></div>
      </header>
      <div class="content-scroll">

        <div id="sec-daily" class="section active">
          <div class="grid-filters">
            <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="d_date" class="form-control"></div>
            <div><label>Ø§Ù„ØµØ§Ù„Ø©</label><select id="d_hall" class="form-control" onchange="loadDailyData()"></select></div>
            <div><label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label><select id="d_shift" class="form-control" onchange="loadDailyData()"></select></div>
            <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="d_type" class="form-control" onchange="loadDailyData()"></select></div>
          </div>
          <div style="background:var(--bg-card); padding:15px; border-radius:var(--radius); border:1px solid var(--border)">
             <div class="instruction-hint">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ØºÙŠØ§Ø¨ØŒ ØªØ£Ø®ÙŠØ±...) Ù‚Ø¨Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>
             <div class="status-selector" id="statusRadios"></div>
             
             <div id="otherInputDiv" class="hidden other-input-container" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                <div style="text-align:center; margin-bottom:5px; font-size:12px; font-weight:bold;">Ù‡Ù„ ØªØ¹ØªØ¨Ø± Ù…Ø®Ø§Ù„ÙØ©ØŸ</div>
                <div class="violation-toggle">
                    <div class="v-option active" data-val="no" onclick="setViolation(false, this)">Ù„ÙŠØ³Øª Ù…Ø®Ø§Ù„ÙØ© âœ…</div>
                    <div class="v-option" data-val="yes" onclick="setViolation(true, this)">Ù…Ø®Ø§Ù„ÙØ© âŒ</div>
                </div>
                <label style="font-size:12px; color:var(--text-muted)">ğŸ“ Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                <input type="text" id="status_manual_text" class="form-control" placeholder="ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©...">
             </div>

             <div id="appInputDiv" class="hidden other-input-container" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                <label style="font-size:12px; color:var(--text-muted)">ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:</label>
                <input type="text" id="app_reason_text" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ù†Ø§...">
             </div>

          </div>
          <div class="transfer-area">
            <div class="list-panel">
              <div class="panel-header"><span>Ø§Ù„Ù…ØªØ§Ø­ (<span id="c-pool">0</span>)</span> <button class="btn-secondary" onclick="moveAll()">Ø§Ù„ÙƒÙ„ â¬…ï¸</button></div>
              <div class="list-box" id="list-pool"></div>
            </div>
            <div class="list-panel" style="border-color:var(--primary)">
              <div class="panel-header"><span>ØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ± (<span id="c-chosen">0</span>)</span> <button class="btn-secondary" onclick="clearChosen()">Ø¥Ø±Ø¬Ø§Ø¹ â¡ï¸</button></div>
              <div class="list-box" id="list-chosen"></div>
            </div>
          </div>
          <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn-primary" onclick="submitDaily()" style="flex:2">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</button>
            <button class="btn-secondary" onclick="toggleSubmittedList()" style="flex:1; border-color:var(--success); color:var(--success)">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</button>
          </div>
          <div id="dailyMsg" style="margin-top:10px"></div>
          
          <div id="submitted-area" class="submitted-section hidden">
              <h4 style="margin:0 0 10px 0; color:var(--text-muted)">ğŸ“‹ ØªÙ… Ø±ÙØ¹Ù‡Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ( <span id="sub-count">0</span> )</h4>
              <div id="submitted-list"></div>
          </div>
        </div>

        <div id="sec-monthly" class="section">
          <div class="grid-filters">
            <div><label>Ø§Ù„Ø³Ù†Ø©</label><input type="number" id="m_year" class="form-control" value="2026"></div>
            <div><label>Ø§Ù„Ø´Ù‡Ø±</label><select id="m_month" class="form-control"></select></div>
            <div><label>Ø§Ù„ØµØ§Ù„Ø©</label><select id="m_hall_filter" class="form-control" onchange="loadMonthlyEntry()"></select></div>
            <div><label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label><select id="m_shift_filter" class="form-control" onchange="loadMonthlyEntry()"></select></div>
            <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="m_type_filter" class="form-control" onchange="loadMonthlyEntry()"></select></div>
            <div style="display:flex; align-items:flex-end"><button class="btn-primary" onclick="loadMonthlyEntry()">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div>
          </div>
          <div class="stats-card">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px;">
              <h3 style="margin:0">âœˆï¸ Ø±ØµØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ†</h3>
              <div style="display:flex; align-items:center; gap:10px">
                  <span id="saveStatusSpan" style="color:var(--success); font-weight:bold; font-size:13px; opacity:0; transition:opacity 0.5s">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…</span>
                  <button class="btn-primary" onclick="submitMonthlyScores()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="score-table">
                <thead><tr><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th><th>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯</th></tr></thead>
                <tbody id="monthlyBody"></tbody>
              </table>
            </div>
            <div id="monthlyMsg" style="margin-top:10px"></div>
          </div>
        </div>

        <div id="sec-record" class="section">
          <div class="grid-filters">
            <div><label>Ø§Ù„ØµØ§Ù„Ø©</label><select id="rec_hall" class="form-control" onchange="filterRecSelect()"></select></div>
            <div><label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label><select id="rec_shift" class="form-control" onchange="filterRecSelect()"></select></div>
            <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="rec_type" class="form-control" onchange="filterRecSelect()"></select></div>
            <div><label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="rec_search_text" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterRecSelect()"></div>
            <div style="flex:2"><label>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¯</label><select id="rec_emp_select" class="form-control"></select></div>
            <div style="display:flex; align-items:flex-end"><button class="btn-primary" onclick="loadSoldierRecord()">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button></div>
          </div>
          <div id="soldier-profile" class="hidden">
            <div class="profile-header">
              <div style="display:flex; gap:15px; align-items:center; width:100%">
                  <div style="font-size:40px; background:rgba(255,255,255,0.1); width:60px; height:60px; display:grid; place-items:center; border-radius:50%">ğŸ‘®</div>
                  <div style="flex:1">
                    <h2 id="p_name" style="margin:0"></h2>
                    <div style="margin-top:5px; color:var(--text-muted)">
                       <span id="p_rank" style="background:var(--primary); padding:2px 8px; border-radius:4px; color:white; font-size:12px"></span>
                       <span id="p_loc" style="margin-right:10px; font-size:13px"></span>
                    </div>
                  </div>
                  <div style="text-align:center">
                    <div style="font-size:12px;color:var(--text-muted)">Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</div>
                    <div style="font-size:24px; font-weight:bold; color:var(--productivity)" id="p_total_prod">0</div>
                  </div>
              </div>
              <div class="profile-stat-group">
                  <div class="mini-stat"><div class="val" id="p_count_absent" style="color:var(--danger)">0</div><div class="lbl">ØºÙŠØ§Ø¨</div></div>
                  <div class="mini-stat"><div class="val" id="p_count_absent_excused" style="color:#d946ef">0</div><div class="lbl">ØºÙŠØ§Ø¨/Ø¨Ø¹Ø°Ø±</div></div>
                  <div class="mini-stat"><div class="val" id="p_count_late" style="color:var(--warning)">0</div><div class="lbl">ØªØ£Ø®ÙŠØ±</div></div>
                  <div class="mini-stat"><div class="val" id="p_count_early" style="color:var(--success)">0</div><div class="lbl">Ø­Ø¶ÙˆØ± Ù…Ø¨ÙƒØ±</div></div>
                  <div class="mini-stat"><div class="val" id="p_count_excused" style="color:#8b5cf6">0</div><div class="lbl">Ø§Ø³ØªØ¦Ø°Ø§Ù†</div></div>
                  <div class="mini-stat"><div class="val" id="p_count_vio" style="color:var(--danger)">0</div><div class="lbl">Ù…Ø®Ø§Ù„ÙØ§Øª</div></div>
              </div>
            </div>
            
            <div class="record-grid">
                <div class="stats-card" style="display:flex; flex-direction:column; align-items:center; margin:0">
                     <h3 style="margin:0 0 15px 0; align-self:flex-start; font-size:16px;">ğŸ§­ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</h3>
                     <div class="gauge-container">
                         <svg class="gauge-svg" viewBox="0 0 200 100">
                             <path class="gauge-arc-bg" d="M20 90 A 80 80 0 0 1 180 90" />
                             <path id="p_gauge_arc" class="gauge-arc-val" d="M20 90 A 80 80 0 0 1 180 90" stroke-dasharray="0, 251" />
                             <polygon id="p_gauge_needle" class="gauge-needle" points="100,90 95,90 100,20 105,90" />
                             <circle cx="100" cy="90" r="5" class="gauge-center" />
                         </svg>
                         <div id="p_gauge_text" class="gauge-text" style="margin-top:-10px">0%</div>
                         <div id="p_gauge_reason" class="gauge-reason" style="color:var(--text-muted)">--</div>
                     </div>
                </div>

                <div class="stats-card doughnut-card" style="margin:0">
                    <h3 style="margin:0 0 15px 0; align-self:flex-start; font-size:16px;">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h3>
                    <div id="p_doughnut" class="doughnut-container">
                        <div class="doughnut-hole">0</div>
                    </div>
                    <div id="p_doughnut_legend" class="doughnut-legend"></div>
                </div>

                <div class="stats-card" style="margin:0">
                  <div style="font-weight:bold; font-size:14px; margin-bottom:15px">ğŸ“ˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© (Ø§Ù„Ø³Ù†ÙˆÙŠ)</div>
                  <div id="p_chart_container" style="display:flex; align-items:flex-end; height:120px; gap:6px; padding-bottom:10px; border-bottom:1px solid var(--border)"></div>
                  <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:9px; color:var(--text-muted)" id="p_chart_labels"></div>
                </div>
            </div>

            <div class="stats-card">
              <div style="font-weight:bold; margin-bottom:10px">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</div>
              <div style="max-height:300px; overflow-y:auto">
                <table class="score-table">
                  <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
                  <tbody id="p_history"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="sec-stats" class="section">
          <div class="grid-filters">
            <div><label>Ù…Ù†</label><input type="date" id="st_from" class="form-control"></div>
            <div><label>Ø¥Ù„Ù‰</label><input type="date" id="st_to" class="form-control"></div>
            <div><label>Ø§Ù„ØµØ§Ù„Ø©</label><select id="st_hall" class="form-control"></select></div>
            <div><label>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label><select id="st_shift" class="form-control"></select></div>
            <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="st_type" class="form-control"></select></div>
            <div style="display:flex; align-items:flex-end"><button class="btn-primary" onclick="loadGeneralStats()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</button></div>
          </div>
          
          <div class="stats-card" style="margin-bottom:20px;">
              <h3 style="margin:0 0 10px 0;">ğŸ“… Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</h3>
              <div class="legend-box">
                  <div class="legend-item"><div class="dot" style="background:#1e3a8a"></div> Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                  <div class="legend-item"><div class="dot" style="background:var(--success)"></div> Ø§Ù†Ø¶Ø¨Ø§Ø·</div>
                  <div class="legend-item"><div class="dot" style="background:var(--danger)"></div> Ù…Ø®Ø§Ù„ÙØ§Øª</div>
              </div>
              <div class="timeline-wrapper">
                  <div id="timeline_chart" class="timeline-container"></div>
              </div>
          </div>

          <div class="stats-card" style="display:flex; flex-direction:column; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0 0 10px 0; align-self:flex-start">ğŸŒ Ù…Ø¤Ø´Ø± Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ø¸Ø§Ù…</h3>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 200 100">
                        <path class="gauge-arc-bg" d="M20 90 A 80 80 0 0 1 180 90" />
                        <path id="g_gauge_arc" class="gauge-arc-val" d="M20 90 A 80 80 0 0 1 180 90" stroke-dasharray="0, 251" />
                        <polygon id="g_gauge_needle" class="gauge-needle" points="100,90 95,90 100,20 105,90" />
                        <circle cx="100" cy="90" r="5" class="gauge-center" />
                    </svg>
                    <div id="g_gauge_text" class="gauge-text" style="margin-top:-10px">0%</div>
                    <div id="g_gauge_reason" class="gauge-reason" style="color:var(--text-muted)">--</div>
                </div>
          </div>
          <div class="kpi-row">
            <div class="kpi-box" style="border-top:3px solid var(--productivity)">
              <div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ†</div>
              <div class="kpi-val" id="g_total_prod" style="color:var(--productivity)">0</div>
            </div>
            <div class="kpi-box" style="border-top:3px solid var(--danger)">
              <div class="kpi-lbl">Ø£ÙƒØ«Ø± ØµØ§Ù„Ø© ØºÙŠØ§Ø¨</div>
              <div class="kpi-val" id="g_most_absent" style="color:var(--danger); font-size:16px">-</div>
              <div style="font-size:10px; color:var(--text-muted)" id="g_most_absent_count"></div>
            </div>
            <div class="kpi-box" style="border-top:3px solid var(--success)">
              <div class="kpi-lbl">Ø£ÙƒØ«Ø± ØµØ§Ù„Ø© Ø§Ù†Ø¶Ø¨Ø§Ø·</div>
              <div class="kpi-val" id="g_most_disciplined" style="color:var(--success); font-size:16px">-</div>
              <div style="font-size:10px; color:var(--text-muted)" id="g_most_disciplined_count"></div>
            </div>
            <div class="kpi-box" style="border-top:3px solid var(--danger)">
              <div class="kpi-lbl">Ø£ÙƒØ«Ø± ØµØ§Ù„Ø© Ù…Ø®Ø§Ù„ÙØ§Øª</div>
              <div class="kpi-val" id="g_most_violations" style="color:var(--danger); font-size:16px">-</div>
              <div style="font-size:10px; color:var(--text-muted)" id="g_most_violations_count"></div>
            </div>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:20px">
            <div class="stats-card">
              <h3>ğŸ† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ù†ØªØ§Ø¬ÙŠØ© (Ù…Ø³Ø§ÙØ±ÙŠÙ†)</h3>
              <div id="prod_leaderboard" class="bar-chart-container"></div>
            </div>
            
            <div class="stats-card">
              <h3>ğŸ–ï¸ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù†Ø¶Ø¨Ø§Ø·Ø§Ù‹ (ØªÙØµÙŠÙ„ÙŠ)</h3>
              <p style="font-size:10px; color:var(--text-muted)">Ø§Ù„Ù…Ø¹ÙŠØ§Ø±: Ø§Ù„Ø­Ø¶ÙˆØ± > Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ù…Ø¨ÙƒØ± > Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</p>
              <div id="discipline_leaderboard" class="bar-chart-container"></div>
            </div>

            <div class="stats-card">
              <h3>âš ï¸ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø®Ø§Ù„ÙØ§Øª (Ø§Ù„Ø¹Ø¯Ø¯)</h3>
              <div id="violations_leaderboard" class="bar-chart-container"></div>
            </div>

            <div class="stats-card">
              <h3>âŒ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØºÙŠØ§Ø¨Ø§Ù‹</h3>
              <div id="absent_leaderboard" class="bar-chart-container"></div>
            </div>

            <div class="stats-card" style="grid-column: 1 / -1;">
              <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø´Ø§Ù…Ù„)</h3>
              <p style="font-size:11px; color:var(--text-muted); margin-bottom:15px">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
              <div id="status_breakdown"></div>
            </div>
          </div>
        </div>

        <div id="sec-requests" class="section">
            <div class="stats-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <h3>ğŸ‘¨â€ğŸ’» Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <button class="btn-primary" style="width:auto; padding:5px 15px; font-size:12px" onclick="approveAllUsers()">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒÙ„</button>
                </div>
                <div id="requestsList">
                    <p style="color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>
                </div>
            </div>
            <div class="stats-card" style="margin-top:20px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <button class="btn-secondary" style="width:auto; padding:5px 15px; font-size:12px; margin:0" onclick="toggleAllUsersList()">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
                </div>
                <div id="allUsersContainer" class="hidden">
                    <div id="allUsersList">
                        <p style="color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-manage" class="section">
           <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:20px">
              <div class="stats-card">
                <h3>ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„Ø£ÙØ±Ø§Ø¯</h3>
                <div style="margin:15px 0">
                    <label>Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¯</label>
                    <input type="text" id="search_move_emp" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«..." onkeyup="filterMoveSelect()" style="margin-bottom:5px">
                    <select id="m_emp" class="form-control"></select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                  <div><label>Ø¥Ù„Ù‰ ØµØ§Ù„Ø©</label><select id="m_new_hall" class="form-control"></select></div>
                  <div><label>Ø¥Ù„Ù‰ Ù…Ù†Ø§ÙˆØ¨Ø©</label><select id="m_new_shift" class="form-control"></select></div>
                </div>
                <div style="margin-top:10px"><label>Ø¥Ù„Ù‰ Ù†ÙˆØ¹</label><select id="m_new_type" class="form-control"></select></div>
                <button class="btn-primary" style="margin-top:15px; width:100%" onclick="moveEmployee()">ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„</button>
                <div id="moveMsg" style="margin-top:10px"></div>
              </div>

              <div class="stats-card">
                <h3>â• / ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯ (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù)</h3>
                <p style="font-size:11px; color:var(--text-muted)">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ÙƒØ´ÙˆÙØ§Øª Ø£Ùˆ Ø­Ø°Ù ÙØ±Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</p>
                
                <div style="border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px">
                    <h4 style="margin:0 0 10px 0; color:var(--success)">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</h4>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                        <input type="text" id="add_name" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…" style="font-size:13px">
                        <input type="text" id="add_rank" class="form-control" placeholder="Ø§Ù„Ø±ØªØ¨Ø©" style="font-size:13px">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px">
                        <select id="add_hall" class="form-control" style="font-size:13px"><option value="1">Øµ1</option><option value="2">Øµ2</option><option value="3">Øµ3</option><option value="4">Øµ4</option><option value="5">Øµ5</option></select>
                        <select id="add_shift" class="form-control" style="font-size:13px"><option value="Ø£">Ø£</option><option value="Ø¨">Ø¨</option><option value="Ø¬">Ø¬</option><option value="Ø¯">Ø¯</option></select>
                        <select id="add_type" class="form-control" style="font-size:13px"><option value="arrival">Ù‚Ø¯ÙˆÙ…</option><option value="departure" selected>Ù…ØºØ§Ø¯Ø±Ø©</option></select>
                    </div>
                    <button class="btn-primary" style="margin-top:10px; background:var(--success)" onclick="addNewEmployeeManual()">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙƒØ´Ù</button>
                </div>

                <div>
                    <h4 style="margin:0 0 10px 0; color:var(--danger)">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</h4>
                    <label>Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¯ Ù„Ù„Ø­Ø°Ù</label>
                    <input type="text" id="search_del_emp" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«..." onkeyup="filterDeleteSelect()" style="margin-bottom:5px">
                    <select id="del_emp_select" class="form-control"></select>
                    <button class="btn-danger" style="margin-top:10px; width:100%" onclick="deleteEmployeeManual()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙØ±Ø¯</button>
                </div>
              </div>

              <div class="stats-card">
                  <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ© (Ø¥Ù†ØªØ§Ø¬ÙŠØ©)</h3>
                  <div style="font-size:12px; color:var(--text-muted); margin-bottom:15px">Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø³Ø§Ø¨Ù‚</div>
                  <div class="grid-filters" style="padding:10px; background:rgba(0,0,0,0.2); grid-template-columns: 1fr 1fr; margin-bottom:10px">
                      <div><label>Ø§Ù„Ø³Ù†Ø©</label><input type="number" id="e_year" class="form-control" value="2026"></div>
                      <div><label>Ø§Ù„Ø´Ù‡Ø±</label><select id="e_month" class="form-control"></select></div>
                  </div>
                  <div style="margin-bottom:10px">
                      <label>Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¯</label>
                      <input type="text" id="e_search" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterEditSelect()">
                  </div>
                  <div style="margin-bottom:10px"><select id="e_emp_select" class="form-control" onchange="fetchStatForEdit()"></select></div>
                  <div id="editStatArea" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px">
                      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                          <span>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                          <input type="number" id="e_score_val" class="score-input" style="width:100px; font-size:16px">
                      </div>
                      <div style="display:flex; gap:10px">
                          <button class="btn-primary" style="flex:1" onclick="updateStat()">ØªØ­Ø¯ÙŠØ«</button>
                          <button class="btn-danger" onclick="deleteStat()">Ø­Ø°Ù</button>
                      </div>
                  </div>
                  <div id="editMsg" style="margin-top:10px"></div>
              </div>
           </div>
        </div>

      </div>
    </main>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://dkrtiuelioyshbjoocqm.supabase.co";
  const SUPABASE_KEY = "sb_publishable_ts5SGrWhODsG6EH5dUt9Wg_KUvsf-CF";

  const HALLS = ["1","2","3","4","5"];
  const SHIFTS = ["Ø£","Ø¨","Ø¬","Ø¯"];
  const HALL_TYPES = { arrival: "Ù‚Ø¯ÙˆÙ…", departure: "Ù…ØºØ§Ø¯Ø±Ø©" };
  const MONTHS = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
  
  const RANK_ORDER = {
      "Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡": 1,
      "Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„": 2,
      "Ø±Ù‚ÙŠØ¨": 3,
      "ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨": 4,
      "Ø¹Ø±ÙŠÙ": 5,
      "Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„": 6,
      "Ø¬Ù†Ø¯ÙŠ": 7
  };

  const STATUSES = {
    early:    { label:"Ø­Ø¶ÙˆØ± Ù…Ø¨ÙƒØ±", color:"#10b981", type:'good' },
    assignment: { label:"ØªÙƒÙ„ÙŠÙ",   color:"#10b981", type:'good' }, 
    late:     { label:"Ù…ØªØ£Ø®Ø±",     color:"#f59e0b", type:'bad' },
    absent:   { label:"ØºÙŠØ§Ø¨",      color:"#ef4444", type:'bad' },
    detained: { label:"Ù…ÙˆÙ‚ÙˆÙ",     color:"#ef4444", type:'bad' },
    app:      { label:"ØªØ·Ø¨ÙŠÙ‚",     color:"#fbbf24", type:'bad' },
    normal:   { label:"Ø­Ø¶ÙˆØ± Ø¹Ø§Ø¯ÙŠ", color:"#3b82f6", type:'neutral' },
    excused:  { label:"Ø§Ø³ØªØ¦Ø°Ø§Ù†",   color:"#8b5cf6", type:'neutral' },
    absent_excused: { label:"ØºÙŠØ§Ø¨/Ø¨Ø¹Ø°Ø±", color:"#d946ef", type:'neutral' }, 
    vacation: { label:"Ø¥Ø¬Ø§Ø²Ø©",     color:"#64748b", type:'neutral' },
    sick:     { label:"Ù…Ø±Ø¶ÙŠØ©",     color:"#f472b6", type:'neutral' },
    newborn:  { label:"Ø±Ø¹Ø§ÙŠØ© Ù…ÙˆÙ„ÙˆØ¯",color:"#d946ef", type:'neutral' },
    death:    { label:"Ø­Ø§Ù„Ø© ÙˆÙØ§Ø©", color:"#94a3b8", type:'neutral' },
    rest:     { label:"Ø±Ø§Ø­Ø©",      color:"#64748b", type:'neutral' },
    course:   { label:"Ø¯ÙˆØ±Ø©",      color:"#8b5cf6", type:'neutral' },
    other:    { label:"ØºÙŠØ± Ø°Ù„Ùƒ",   color:"#e2e8f0", type:'neutral' }
  };

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let sessionUser = null;
  let employees = [];
  let dailyPool = [], chosen = [];
  let curStatus = "normal";
  let isViolation = false; 

  const $ = (id) => document.getElementById(id);
  const today = () => new Date().toISOString().split('T')[0];

  // --- Hijri Converter Helper ---
  function toHijri(dateStr) {
      if(!dateStr) return "-";
      const date = new Date(dateStr);
      // 'en-TN-u-ca-islamic-umalqura' provides proper numbering, ar-SA sometimes uses names.
      // We use 'ar-SA-u-ca-islamic-umalqura' for Arabic locale context
      return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {
          day: 'numeric', month: 'long', year: 'numeric' 
      }).format(date);
  }

  window.onload = async () => {
    $('d_date').value = $('st_from').value = $('st_to').value = today();
    $('dateNow').textContent = new Date().toLocaleDateString('ar-SA');
    
    // Fill Selects with DEFAULT DEPARTURE
    [ 'd_hall', 'm_hall_filter', 'm_new_hall', 'st_hall', 'rec_hall' ].forEach(id => fillSelect(id, HALLS, true));
    [ 'd_shift', 'm_shift_filter', 'm_new_shift', 'st_shift', 'rec_shift' ].forEach(id => fillSelect(id, SHIFTS, true));
    
    // Fill Type Selects & Set Default to Departure
    [ 'd_type', 'm_type_filter', 'm_new_type', 'st_type', 'rec_type' ].forEach(id => {
        const el = $(id); el.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
        el.innerHTML += `<option value="departure" selected>Ù…ØºØ§Ø¯Ø±Ø©</option>`;
        el.innerHTML += `<option value="arrival">Ù‚Ø¯ÙˆÙ…</option>`;
        el.value = 'departure'; 
    });

    const mSel = $('m_month');
    const eSel = $('e_month');
    MONTHS.forEach((m,i) => {
        mSel.innerHTML += `<option value="${i+1}">${m}</option>`;
        eSel.innerHTML += `<option value="${i+1}">${m}</option>`;
    });
    mSel.value = eSel.value = new Date().getMonth() + 1;

    const radioDiv = $('statusRadios');
    for(const [k,v] of Object.entries(STATUSES)){
      const lbl = document.createElement('label');
      lbl.className = 'radio-label';
      lbl.setAttribute('data-type', v.type);
      lbl.style.color = v.color;
      lbl.style.borderColor = v.color;
      lbl.innerHTML = `<input type="radio" name="st" value="${k}" ${k==='normal'?'checked':''} onchange="changeStatus(this.value)">${v.label}`;
      radioDiv.appendChild(lbl);
    }

    checkAuth();
  };

  function fillSelect(id, arr, hasAll=false){
    const el = $(id); el.innerHTML = hasAll ? '<option value="">Ø§Ù„ÙƒÙ„</option>' : '';
    arr.forEach(x => el.innerHTML += `<option value="${x}">${x}</option>`);
    if(!hasAll && el.options.length) el.selectedIndex = 0;
  }

  function toggleSidebar() {
      const sb = document.getElementById('mainSidebar');
      const ov = document.getElementById('mobileOverlay');
      sb.classList.toggle('active');
      ov.classList.toggle('active');
  }

  function toggleAuthMode() {
      const login = $('loginForm');
      const reg = $('registerForm');
      if(login.classList.contains('hidden')) {
          login.classList.remove('hidden'); reg.classList.add('hidden');
      } else {
          login.classList.add('hidden'); reg.classList.remove('hidden');
      }
  }

  function toggleAllUsersList() {
      const el = $('allUsersContainer');
      if(el.classList.contains('hidden')) {
          el.classList.remove('hidden');
          loadAllApprovedUsers(); 
      } else {
          el.classList.add('hidden');
      }
  }

  function go(pg){
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    $('sec-'+pg).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    $('nav-'+pg).classList.add('active');
    $('pageTitle').textContent = $(`nav-${pg}`).textContent.trim();
    if(window.innerWidth <= 768) { const sb = document.getElementById('mainSidebar'); if(sb.classList.contains('active')) toggleSidebar(); }
    
    if(pg === 'requests' && isAdmin) loadRequests();
  }

  function changeStatus(val) {
      curStatus = val;
      $('otherInputDiv').classList.add('hidden');
      $('appInputDiv').classList.add('hidden');

      if(val === 'other') {
          $('otherInputDiv').classList.remove('hidden');
      } else if (val === 'app') {
          $('appInputDiv').classList.remove('hidden');
      }
  }

  function setViolation(isBad, el) {
      isViolation = isBad;
      document.querySelectorAll('.v-option').forEach(d => d.classList.remove('active'));
      el.classList.add('active');
  }

  let isAdmin = false;

  async function checkAuth(){
    const {data} = await sb.auth.getSession();
    sessionUser = data.session?.user;
    
    if(sessionUser){
      $('authScreen').classList.add('hidden');
      const meta = sessionUser.user_metadata || {};
      const disp = meta.display_name || meta.name || meta.full_name || sessionUser.email.split('@')[0];
      
      $('userDisplayName').innerHTML = `<div style="font-weight:bold; font-size:14px; margin-bottom:5px">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${disp}</div>`;

      if(meta.hall) {
          if($('d_hall')) $('d_hall').value = meta.hall;
          if($('st_hall')) $('st_hall').value = meta.hall;
          if($('rec_hall')) $('rec_hall').value = meta.hall;
      }
      if(meta.shift) {
          if($('d_shift')) $('d_shift').value = meta.shift;
          if($('st_shift')) $('st_shift').value = meta.shift;
          if($('rec_shift')) $('rec_shift').value = meta.shift;
      }

      await checkPermissions();
      loadEmployees(); 
    } else {
      $('authScreen').classList.remove('hidden');
    }
  }

  async function checkPermissions() {
      if (sessionUser.email === 'shift-management@test.com') {
          isAdmin = true;
          $('userDisplayName').innerHTML += ' <span style="color:#10b981; font-size:11px; display:block">â— Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ÙˆÙ„Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªØ§Ø­Ø© ( Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯ )</span>';
          $('nav-requests').classList.remove('hidden');
          checkNotifications();
          return; 
      }

      const { data, error } = await sb
          .from('allowed_users')
          .select('email')
          .eq('email', sessionUser.email)
          .single();
      
      if (data) {
          isAdmin = true;
          $('userDisplayName').innerHTML += ' <span style="color:#10b981; font-size:11px; display:block">â— Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ÙˆÙ„Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªØ§Ø­Ø© ( Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯ )</span>';
          $('nav-requests').classList.remove('hidden');
          checkNotifications();
      } else {
          isAdmin = false;
          $('userDisplayName').innerHTML += ' <span style="color:#f59e0b; font-size:11px; display:block">â— Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ÙˆÙ„Ø©: Ø¨Ø¯ÙˆÙ† (ÙÙ‚Ø· Ù„Ù„Ø§Ø·Ù„Ø§Ø¹)</span>';
          disableEditingUI();
      }
  }

  async function checkNotifications() {
      const { count } = await sb.from('employees').select('*', { count: 'exact', head: true }).eq('is_approved', false).neq('email', null);
      if(count > 0) {
          $('reqBadge').textContent = count;
          $('reqBadge').classList.remove('hidden');
      } else {
          $('reqBadge').classList.add('hidden');
      }
  }

  function disableEditingUI() {
      const btns = document.querySelectorAll('button.btn-primary');
      btns.forEach(btn => {
          const txt = btn.textContent;
          if (txt.includes('Ø­ÙØ¸') || txt.includes('Ù†Ù‚Ù„') || txt.includes('ØªØ­Ø¯ÙŠØ«') || txt.includes('Ø¥Ù†Ø´Ø§Ø¡') || txt.includes('Ù‚Ø¨ÙˆÙ„') || txt.includes('Ø¥Ø¶Ø§ÙØ©')) {
              if(btn.closest('.auth-box')) return; 
              btn.disabled = true; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; btn.innerHTML = 'ğŸ”’ ' + txt; btn.title = "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
          }
      });
      const delBtns = document.querySelectorAll('button.btn-danger');
      delBtns.forEach(btn => {
          const txt = btn.textContent;
          btn.disabled = true; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; btn.innerHTML = 'ğŸ”’ ' + txt; btn.title = "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø­Ø°Ù";
      });
      if($('otherInputDiv')) $('otherInputDiv').classList.add('hidden');
  }

  async function signIn(){
    const { data, error } = await sb.auth.signInWithPassword({
      email: $('email').value, password: $('password').value
    });
    
    if(error) {
        $('authMsg').textContent = error.message; 
    } else {
        const { data: empData } = await sb.from('employees').select('is_approved').eq('id', data.user.id).single();
        if(data.user.email === 'shift-management@test.com' || (empData && empData.is_approved)) {
            checkAuth();
        } else {
            await sb.auth.signOut();
            $('authMsg').innerHTML = `<span style="color:#ef4444; font-weight:bold">â›” ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆÙ„ÙƒÙ† Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø¯Ø®ÙˆÙ„.</span>`;
        }
    }
  }

  async function signUp(){
      const email = $('reg_email').value;
      const pass = $('reg_pass').value;
      const rank = $('reg_rank').value;
      const name = $('reg_name').value;
      const hall = $('reg_hall').value || null;
      const shift = $('reg_shift').value || null;
      const type = $('reg_type').value || null;

      if(!email || !pass || !name) {
          $('regMsg').textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"; return;
      }

      const { data: authData, error: authError } = await sb.auth.signUp({
        email: email, password: pass,
        options: { data: { display_name: `${rank} ${name}`, hall: hall, shift: shift, hall_type: type } }
      });

      if(authError) {
          $('regMsg').textContent = authError.message;
          return;
      }

      if(authData.user) {
          const { error: dbError } = await sb.from('employees').insert({
              id: authData.user.id,
              name: name,
              rank: rank,
              hall: hall, 
              shift: shift,
              hall_type: type,
              email: email,
              is_approved: false 
          });

          if(dbError) {
              $('regMsg').textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + dbError.message;
          } else {
              await sb.auth.signOut(); 
              alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±.');
              toggleAuthMode();
          }
      }
  }

  async function logout(){ await sb.auth.signOut(); location.reload(); }

  async function loadRequests() {
      const list = $('requestsList');
      list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
      const { data: reqs, error } = await sb.from('employees').select('*').eq('is_approved', false).neq('email', null); 
      
      if(!reqs || reqs.length === 0) {
          list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©</div>';
          return;
      }

      list.innerHTML = '';
      reqs.forEach(r => {
          if(!r.email) return;
          const item = document.createElement('div');
          item.style.cssText = "background:rgba(255,255,255,0.05); padding:15px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border)";
          item.innerHTML = `
            <div>
                <div style="font-weight:bold; color:var(--text-main)">${r.rank || ''} ${r.name}</div>
                <div style="font-size:12px; color:var(--text-muted)">${r.email}</div>
                <div style="font-size:11px; margin-top:5px; color:var(--productivity)">ØµØ§Ù„Ø© ${r.hall || '-'} | Ù…Ù†Ø§ÙˆØ¨Ø© ${r.shift || '-'}</div>
            </div>
            <div style="display:flex; gap:10px">
                <button class="btn-primary" style="padding:8px 15px; font-size:12px; background:var(--success); width:auto" onclick="approveUser('${r.id}')">Ù‚Ø¨ÙˆÙ„ âœ…</button>
                <button class="btn-danger" style="padding:8px 15px; font-size:12px; width:auto" onclick="deleteUser('${r.id}')">Ø±ÙØ¶ âŒ</button>
            </div>
          `;
          list.appendChild(item);
      });
  }

  async function loadAllApprovedUsers() {
      const list = $('allUsersList');
      list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
      
      const { data: admins } = await sb.from('allowed_users').select('email');
      const adminEmails = admins ? admins.map(a => a.email.toLowerCase().trim()) : [];

      const { data: users } = await sb.from('employees').select('*').neq('email', null);
      
      if(!users || users.length === 0) {
          list.innerHTML = '<div style="padding:10px; text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</div>';
          return;
      }

      list.innerHTML = '';
      users.forEach(r => {
          const userEmail = r.email ? r.email.toLowerCase().trim() : '';
          const isAdminUser = adminEmails.includes(userEmail);
          
          const statusBadge = r.is_approved 
            ? '<span style="color:var(--success); border:1px solid var(--success); padding:2px 6px; border-radius:4px; font-size:10px">Ù†Ø´Ø·</span>' 
            : '<span style="color:var(--warning); border:1px solid var(--warning); padding:2px 6px; border-radius:4px; font-size:10px">ØºÙŠØ± Ù…ÙØ¹Ù„</span>';

          let btnHtml = '';
          
          if(isAdminUser) {
              btnHtml = `<button class="btn-warning" style="padding:6px 12px; font-size:11px; width:auto" onclick="revokeAdmin('${r.email}')">Ø³Ø­Ø¨ Ø¥Ø¯Ø§Ø±Ø© ğŸ”½</button>`;
          } else {
              btnHtml = `<button class="btn-primary" style="padding:6px 12px; font-size:11px; background:var(--admin); width:auto" onclick="makeAdmin('${r.id}', '${r.email}')">ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø¯ÙŠØ± ğŸ”¼</button>`;
          }
          
          if(!r.is_approved){
               btnHtml += `<button class="btn-primary" style="padding:6px 12px; font-size:11px; background:var(--success); width:auto; margin-right:5px" onclick="approveUser('${r.id}')">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…</button>`;
          }

          btnHtml += `<button class="btn-danger" style="padding:6px 12px; font-size:11px; width:auto; margin-right:5px" onclick="deleteSystemUser('${r.id}')">Ø­Ø°Ù ğŸ—‘ï¸</button>`;

          const item = document.createElement('div');
          item.style.cssText = "background:rgba(0,0,0,0.2); padding:15px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border)";
          item.innerHTML = `
            <div>
                <div style="font-weight:bold; color:var(--text-main)">${r.rank || ''} ${r.name} ${statusBadge}</div>
                <div style="font-size:11px; color:var(--text-muted)">${r.email}</div>
            </div>
            <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap">
                ${btnHtml}
            </div>
          `;
          list.appendChild(item);
      });
  }

  async function approveUser(id) {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ')) return;
      const { error } = await sb.from('employees').update({ is_approved: true }).eq('id', id);
      if(error) alert('Ø®Ø·Ø£: ' + error.message); else { loadRequests(); checkNotifications(); loadEmployees(); loadAllApprovedUsers(); }
  }
  
  async function makeAdmin(id, email) {
      if(!email) return alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„');
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© (Ù…Ø¯ÙŠØ±)ØŸ')) return;
      const { error } = await sb.from('allowed_users').insert({ email: email.toLowerCase().trim() });
      if(error) alert(error.message); else { alert('ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…'); loadAllApprovedUsers(); }
  }

  async function revokeAdmin(email) {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ø­Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ØŸ')) return;
      const { error } = await sb.from('allowed_users').delete().eq('email', email.toLowerCase().trim());
      if(error) alert(error.message); else { alert('ØªÙ… Ø³Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª'); loadAllApprovedUsers(); }
  }

  async function deleteSystemUser(id) {
      if(!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      const { error } = await sb.from('employees').delete().eq('id', id);
      if(error) alert(error.message); else { alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); loadAllApprovedUsers(); loadEmployees(); }
  }

  async function approveAllUsers() {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©ØŸ')) return;
      const { error } = await sb.from('employees').update({ is_approved: true }).eq('is_approved', false);
      if(error) alert('Ø®Ø·Ø£: ' + error.message); else { alert('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ âœ…'); loadRequests(); checkNotifications(); loadEmployees(); }
  }

  async function deleteUser(id) { 
      if(!confirm('Ø³ÙŠØªÙ… Ø±ÙØ¶ ÙˆØ­Ø°Ù Ø§Ù„Ø·Ù„Ø¨. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      const { error } = await sb.from('employees').delete().eq('id', id);
      if(error) alert('Ø®Ø·Ø£: ' + error.message); else { loadRequests(); checkNotifications(); }
  }

  // --- Main Data Loading (Manual Employees Only) ---
  async function loadEmployees(){
    const {data} = await sb.from('employees')
        .select('*')
        .eq('is_approved', true)
        .is('email', null); // FILTER: Manual employees only (no email)
    
    if(data) {
        employees = data.sort((a,b) => {
            const rankA = RANK_ORDER[a.rank] || 99;
            const rankB = RANK_ORDER[b.rank] || 99;
            return rankA - rankB;
        });
    } else {
        employees = [];
    }

    loadDailyData();
    filterRecSelect(); 
    filterEditSelect();
    filterMoveSelect();  
    filterDeleteSelect(); 
  }

  function loadDailyData(){
    const h = $('d_hall').value;
    const s = $('d_shift').value;
    const t = $('d_type').value; 
    
    $('submitted-area').classList.add('hidden');

    if (!h || !s || !t) {
        dailyPool = [];
        $('c-pool').textContent = 0;
        $('list-pool').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ§Ù„Ø© ÙˆØ§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙˆÙ†ÙˆØ¹ Ø§Ù„ØµØ§Ù„Ø©</div>';
        chosen = [];
        $('list-chosen').innerHTML = '';
        $('c-chosen').textContent = 0;
        return;
    }

    dailyPool = employees.filter(e => 
        (e.hall == h) && 
        (e.shift == s) &&
        (e.hall_type == t)
    );
    chosen = [];
    renderDaily();
  }

  function renderDaily(){
    const p = $('list-pool'), c = $('list-chosen');
    p.innerHTML = ''; c.innerHTML = '';
    
    const chIds = chosen.map(x=>x.id);
    const avail = dailyPool.filter(x => !chIds.includes(x.id));

    $('c-pool').textContent = avail.length;
    $('c-chosen').textContent = chosen.length;

    avail.forEach(e => {
      const d = document.createElement('div'); d.className = 'list-item';
      d.innerHTML = `<span>${e.name}</span> <span class="emp-meta">${e.rank||''}</span>`;
      d.onclick = () => { 
          let note = "";
          if (curStatus === 'other') {
              const text = $('status_manual_text').value.trim();
              note = isViolation ? `[Ù…Ø®Ø§Ù„ÙØ©] ${text}` : text;
          } else if (curStatus === 'app') {
              note = $('app_reason_text').value.trim();
          }
          chosen.push({...e, st:curStatus, manualNote: note}); 
          renderDaily(); 
      };
      p.appendChild(d);
    });

    chosen.forEach((e, idx) => {
      const def = STATUSES[e.st];
      
      const d = document.createElement('div'); d.className = 'list-item selected';
      d.style.borderColor = def.color;
      d.style.backgroundColor = `${def.color}15`; 
      
      d.innerHTML = `
        <div style="width:100%">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span>${e.name}</span>
                <small style="color:${def.color}; font-weight:bold">${def.label}</small>
            </div>
            ${e.manualNote ? `<div style="font-size:10px; color:var(--text-muted); margin-top:3px">ğŸ“ ${e.manualNote}</div>` : ''}
        </div>`;
        
      d.onclick = () => { chosen.splice(idx,1); renderDaily(); };
      c.appendChild(d);
    });
  }

  function moveAll(){
    const chIds = chosen.map(x=>x.id);
    let note = "";
    if (curStatus === 'other') {
        const text = $('status_manual_text').value.trim();
        note = isViolation ? `[Ù…Ø®Ø§Ù„ÙØ©] ${text}` : text;
    } else if (curStatus === 'app') {
        note = $('app_reason_text').value.trim();
    }
    dailyPool.filter(x => !chIds.includes(x.id)).forEach(e => chosen.push({...e, st:curStatus, manualNote: note}));
    renderDaily();
  }

  function clearChosen(){ chosen=[]; renderDaily(); }
  
  async function submitDaily(){
    if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª "Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·".'); return; }
    if(!chosen.length) return alert('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©');
    
    $('dailyMsg').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø­ÙØ¸...';
    
    const finalInserts = [];
    const date = $('d_date').value;
    const currentHallType = $('d_type').value;

    const { data: existingEvents } = await sb.from('events')
        .select('employee_id, status')
        .eq('event_date', date);

    for (let c of chosen) {
        const userPrevEvents = existingEvents ? existingEvents.filter(e => e.employee_id === c.id) : [];
        
        let proceed = true;
        if(userPrevEvents.length > 0) {
             const prevStatuses = userPrevEvents.map(e => STATUSES[e.status]?.label || e.status).join(' Ùˆ ');
             const newStatus = STATUSES[c.st]?.label || c.st;
             
             proceed = confirm(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…ÙˆØ¸Ù: ${c.name}\n\nÙ„Ø¯ÙŠÙ‡ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚ Ø§Ù„ÙŠÙˆÙ…: (${prevStatuses})\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ù‡ Ø¨ØµÙØ©: (${newStatus})ØŸ`);
        }

        if(proceed) {
            finalInserts.push({
                event_date: date, 
                hall: $('d_hall').value, 
                shift: $('d_shift').value,
                hall_type: currentHallType,
                employee_id: c.id, 
                status: c.st, 
                note: c.manualNote || null,
                created_by: sessionUser.id
            });
        }
    }

    if(finalInserts.length === 0) {
        $('dailyMsg').textContent = 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡.';
        return;
    }

    const {error} = await sb.from('events').insert(finalInserts);
    
    if(error) { 
        console.error(error);
        $('dailyMsg').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message; 
        if(error.message.includes('unique')) alert('âš ï¸ Ø®Ø·Ø£: Ù…Ø§ Ø²Ø§Ù„ Ø§Ù„Ù‚ÙŠØ¯ (Unique Constraint) Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\nÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° ÙƒÙˆØ¯ SQL Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ Ù…Ù† Ø¬Ø¯ÙˆÙ„ events.');
        if(error.message.includes('check constraint')) alert('âš ï¸ Ø®Ø·Ø£: Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\nÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° ÙƒÙˆØ¯ SQL Ù„Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ "events_status_check".');
    } else { 
        $('dailyMsg').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…'; 
        chosen=[]; 
        renderDaily(); 
        $('status_manual_text').value='';
        $('app_reason_text').value='';
        if(!$('submitted-area').classList.contains('hidden')) loadSubmittedToday();
    }
  }

  async function toggleSubmittedList() {
      const area = $('submitted-area');
      if (area.classList.contains('hidden')) {
          area.classList.remove('hidden');
          await loadSubmittedToday();
      } else {
          area.classList.add('hidden');
      }
  }

  async function loadSubmittedToday() {
      const h = $('d_hall').value;
      const s = $('d_shift').value;
      const d = $('d_date').value;
      
      const listDiv = $('submitted-list');
      listDiv.innerHTML = '<div style="color:var(--text-muted); font-size:12px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

      const { data: evs, error } = await sb
          .from('events')
          .select('id, status, note, employees!inner(name, rank)')
          .eq('event_date', d)
          .eq('hall', h)
          .eq('shift', s);
      
      if(error || !evs || evs.length === 0) {
          listDiv.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø±ÙÙˆØ¹Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</div>';
          $('sub-count').textContent = 0;
          return;
      }

      listDiv.innerHTML = '';
      $('sub-count').textContent = evs.length;

      evs.forEach(ev => {
          const stDef = STATUSES[ev.status] || STATUSES.normal;
          const noteTxt = ev.note ? ` - <span style="opacity:0.8">(${ev.note})</span>` : '';
          
          let actionBtn = '';
          if(isAdmin) {
              actionBtn = `<button class="btn-danger" style="padding:4px 8px; font-size:10px; width:auto; margin:0" onclick="deleteEvent('${ev.id}')">Ø­Ø°Ù/ØªØ¹Ø¯ÙŠÙ„</button>`;
          }

          const item = document.createElement('div');
          item.className = 'submitted-item';
          item.innerHTML = `
            <div>
                <span style="font-weight:bold; margin-left:5px">${ev.employees.name}</span>
                <span class="meta">${ev.employees.rank || ''}</span>
                <span style="color:${stDef.color}; font-size:11px; font-weight:bold">${stDef.label} ${noteTxt}</span>
            </div>
            ${actionBtn}
          `;
          listDiv.appendChild(item);
      });
  }

  async function deleteEvent(eventId) {
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¶ÙŠØ±ØŸ')) return;
      const { error } = await sb.from('events').delete().eq('id', eventId);
      if(error) alert(error.message);
      else {
          loadSubmittedToday();
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù.');
      }
  }

  async function deleteEventFromHistory(eventId) {
      if (!isAdmin) { alert('ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
      const { error } = await sb.from('events').delete().eq('id', eventId);
      if(error) alert(error.message);
      else {
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
          loadSoldierRecord();
      }
  }

  async function loadMonthlyEntry(){
    const y = $('m_year').value, m = $('m_month').value;
    const h = $('m_hall_filter').value;
    const s = $('m_shift_filter').value;
    const t = $('m_type_filter').value;

    const targetEmps = employees.filter(e => 
        (!h || e.hall == h) && 
        (!s || e.shift == s) &&
        (!t || e.hall_type == t)
    );

    const {data: stats} = await sb.from('monthly_stats').select('*').eq('year', y).eq('month', m);
    const statMap = {};
    if(stats) stats.forEach(x => statMap[x.employee_id] = x.score);

    const tb = $('monthlyBody'); tb.innerHTML = '';
    targetEmps.forEach(e => {
      const val = statMap[e.id];
      const displayVal = (val !== undefined && val !== null) ? val : '';
      
      tb.innerHTML += `<tr>
        <td>${e.name}</td><td><span class="emp-meta">${e.rank||''}</span></td>
        <td style="opacity:0.7">${displayVal || '-'}</td>
        <td><input type="number" class="score-input" min="0" value="${displayVal}" id="sc_${e.id}" placeholder=""></td>
      </tr>`;
    });
  }
  async function submitMonthlyScores(){
    if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
    const y = $('m_year').value, m = $('m_month').value;
    const inputs = document.querySelectorAll('input[id^="sc_"]');
    const updates = [];
    inputs.forEach(inp => {
        const eid = inp.id.split('_')[1];
        if(inp.value !== '') updates.push({ employee_id: eid, year: y, month: m, score: parseInt(inp.value) });
    });

    if(!updates.length) return;
    
    const span = $('saveStatusSpan');
    span.style.opacity = '1';
    
    const {error} = await sb.from('monthly_stats').upsert(updates, {onConflict:'employee_id,year,month'});
    if(error) { 
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message); 
    } else { 
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    }

    setTimeout(() => { span.style.opacity = '0'; }, 3000);
  }

  function filterRecSelect(){
     const h = $('rec_hall').value;
     const s = $('rec_shift').value;
     const t = $('rec_type').value;
     const txt = $('rec_search_text').value.toLowerCase();
     const el = $('rec_emp_select'); el.innerHTML = '';
     
     let filtered = employees.filter(e => 
        (!h || e.hall == h) && 
        (!s || e.shift == s) &&
        (!t || e.hall_type == t) &&
        (!txt || e.name.toLowerCase().includes(txt))
     );

     if(filtered.length === 0) el.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</option>';
     filtered.forEach(e => { el.innerHTML += `<option value="${e.id}">${e.name} (${e.hall || '-'}-${e.shift || '-'})</option>`; });
     if(filtered.length) el.selectedIndex = 0;
  }

  function calculateScore(status, note) {
      if (status === 'other' && note && note.includes('[Ù…Ø®Ø§Ù„ÙØ©]')) return -10;
      
      if(status === 'early') return 10;
      if(status === 'normal') return 8; 
      if(status === 'late') return 1;   
      if(status === 'app') return -10;
      if(status === 'detained') return -10;
      if(status === 'absent') return -20;
      if(STATUSES[status] && STATUSES[status].type === 'neutral') return null;
      return 0; 
  }

  async function updateEventStatus(id, newStatus, reason) {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¨Ø±ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØºÙŠØ§Ø¨ØŸ')) return;
      const { error } = await sb.from('events')
          .update({ status: 'absent_excused', note: reason }) // Changed to absent_excused
          .eq('id', id);
      
      if(error) alert('Ø®Ø·Ø£: ' + error.message);
      else {
          alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          loadSoldierRecord(); 
      }
  }

  async function loadSoldierRecord(){
    const id = $('rec_emp_select').value;
    if(!id) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¯');
    const emp = employees.find(e => e.id == id);
    
    $('soldier-profile').classList.remove('hidden');
    $('p_name').textContent = emp.name;
    $('p_rank').textContent = emp.rank || 'ÙØ±Ø¯';
    $('p_loc').textContent = `ØµØ§Ù„Ø© ${emp.hall || '-'} | Ù…Ù†Ø§ÙˆØ¨Ø© ${emp.shift || '-'} | ${HALL_TYPES[emp.hall_type] || ''}`;
    
    const {data: evs} = await sb.from('events').select('*').eq('employee_id', emp.id).order('event_date', {ascending:false}).limit(100);
    const tb = $('p_history'); tb.innerHTML = '';
    
    let cAbsent=0, cLate=0, cEarly=0, cExcused=0, cVio=0, cAbsentExcused=0;
    
    let totalPoints = 0;
    let countedDays = 0;

    if(evs) {
        evs.forEach(ev => {
            const stDef = STATUSES[ev.status] || STATUSES.normal;
            if(ev.status === 'absent') cAbsent++;
            if(ev.status === 'late') cLate++;
            if(ev.status === 'early') cEarly++;
            if(ev.status === 'excused') cExcused++;
            if(ev.status === 'absent_excused') cAbsentExcused++; // Counter
            
            const isFlagged = (ev.status === 'other' && ev.note && ev.note.includes('[Ù…Ø®Ø§Ù„ÙØ©]'));
            if(stDef.type === 'bad' || isFlagged) cVio++;
            
            const pts = calculateScore(ev.status, ev.note);
            if (pts !== null) {
                totalPoints += pts;
                countedDays++;
            }

            let noteTxt = ev.note || '-';
            
            // Buttons logic
            let actionHtml = '';
            // Justify Button (Left of Note)
            if(ev.status === 'absent') {
                actionHtml += `<button class="excuse-btn" onclick="const r=prompt('Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨:'); if(r) updateEventStatus('${ev.id}','absent_excused',r)" style="margin-left:8px">ØªØ¨Ø±ÙŠØ± ğŸ›¡ï¸</button>`;
            }
            // Delete Button (Admin Only)
            if(isAdmin) {
                actionHtml += `<button class="delete-btn-sm" onclick="deleteEventFromHistory('${ev.id}')">ğŸ—‘ï¸</button>`;
            }

            // --- Updated Table Row with Hijri Date ---
            const hijriDate = toHijri(ev.event_date);
            tb.innerHTML += `
            <tr>
                <td>${ev.event_date}</td>
                <td style="font-size:11px; color:var(--text-muted)">${hijriDate}</td>
                <td><span style="color:${stDef.color}; font-weight:bold">${stDef.label}</span></td>
                <td>
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
                        <span>${noteTxt}</span>
                        <div style="display:flex; align-items:center">${actionHtml}</div>
                    </div>
                </td>
            </tr>`;
        });
    }
    $('p_count_absent').textContent = cAbsent;
    $('p_count_late').textContent = cLate;
    $('p_count_early').textContent = cEarly;
    $('p_count_excused').textContent = cExcused;
    $('p_count_vio').textContent = cVio;
    $('p_count_absent_excused').textContent = cAbsentExcused;

    // --- Doughnut Chart Logic ---
    const totalEvents = cAbsent + cAbsentExcused + cLate + cEarly + cExcused;
    const doughnut = $('p_doughnut');
    const legend = $('p_doughnut_legend');
    
    if(totalEvents > 0) {
        // Calculate percentages
        const pAbsent = (cAbsent / totalEvents) * 100;
        const pAbsentEx = (cAbsentExcused / totalEvents) * 100;
        const pLate = (cLate / totalEvents) * 100;
        const pEarly = (cEarly / totalEvents) * 100;
        const pExcused = (cExcused / totalEvents) * 100;

        // Create Conic Gradient
        let currentDeg = 0;
        const colors = [];
        
        // Helper to add segment
        const addSeg = (pct, color) => {
            if(pct > 0) {
                colors.push(`${color} ${currentDeg}% ${currentDeg + pct}%`);
                currentDeg += pct;
            }
        };

        addSeg(pAbsent, STATUSES.absent.color);
        addSeg(pAbsentEx, STATUSES.absent_excused.color);
        addSeg(pLate, STATUSES.late.color);
        addSeg(pEarly, STATUSES.early.color);
        addSeg(pExcused, STATUSES.excused.color);

        doughnut.style.background = `conic-gradient(${colors.join(', ')})`;
        doughnut.querySelector('.doughnut-hole').textContent = totalEvents;

        // Create Legend
        legend.innerHTML = `
            <div class="d-leg-item"><div class="d-leg-color" style="background:${STATUSES.absent.color}"></div>ØºÙŠØ§Ø¨ (${cAbsent})</div>
            <div class="d-leg-item"><div class="d-leg-color" style="background:${STATUSES.absent_excused.color}"></div>Ø¨Ø¹Ø°Ø± (${cAbsentExcused})</div>
            <div class="d-leg-item"><div class="d-leg-color" style="background:${STATUSES.late.color}"></div>ØªØ£Ø®ÙŠØ± (${cLate})</div>
            <div class="d-leg-item"><div class="d-leg-color" style="background:${STATUSES.early.color}"></div>Ù…Ø¨ÙƒØ± (${cEarly})</div>
            <div class="d-leg-item"><div class="d-leg-color" style="background:${STATUSES.excused.color}"></div>Ø§Ø³ØªØ¦Ø°Ø§Ù† (${cExcused})</div>
        `;
    } else {
        doughnut.style.background = '#334155'; // Empty color
        doughnut.querySelector('.doughnut-hole').textContent = '0';
        legend.innerHTML = '<span style="color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span>';
    }


    let scorePercent = 0;
    let reasonText = "Ø¹Ø§Ø¯ÙŠ";
    let reasonColor = "var(--text-muted)";

    if(countedDays < 3) {
        scorePercent = 50; 
    } else {
        const maxPossible = countedDays * 10;
        scorePercent = (totalPoints / maxPossible) * 100;

        const y = new Date().getFullYear();
        const {data: stats} = await sb.from('monthly_stats').select('month,score').eq('employee_id', emp.id).eq('year', y);
        let totalProd = 0;
        if(stats) stats.forEach(s => totalProd += s.score);
        
        let boost = 0;
        if(totalProd > 2000) boost += 2;
        if(totalProd > 3000) boost += 2; 
        if(totalProd > 4000) boost += 2;
        
        scorePercent += boost;

        if(scorePercent > 100) scorePercent = 100;
        if(scorePercent < 0) scorePercent = 0;

        if(scorePercent < 50) { 
            reasonText = `Ù…Ù†Ø®ÙØ¶ (${cVio} Ù…Ø®Ø§Ù„ÙØ©)`; 
            reasonColor = "var(--danger)"; 
        } else if (scorePercent < 70) {
            reasonText = "Ù…ØªÙˆØ³Ø·";
            reasonColor = "var(--warning)";
        } else if (scorePercent < 90) {
            reasonText = "Ø¬ÙŠØ¯";
            reasonColor = "#3b82f6";
        } else {
            reasonText = "Ù…Ù…ÙŠØ²";
            reasonColor = "var(--success)";
        }
    }

    updateGauge('p', scorePercent, reasonText, reasonColor);

    const chart = $('p_chart_container'); chart.innerHTML = '';
    const labels = $('p_chart_labels'); labels.innerHTML = '';
    
    const y = new Date().getFullYear();
    const {data: stats} = await sb.from('monthly_stats').select('month,score').eq('employee_id', emp.id).eq('year', y);
    let totalProd = 0;
    if(stats) stats.forEach(s => totalProd += s.score);
    $('p_total_prod').textContent = totalProd;

    let max = 0;
    if(stats) stats.forEach(s => { if(s.score > max) max = s.score; });
    MONTHS.forEach((mName, i) => {
      const idx = i+1; const rec = stats?.find(s => s.month === idx); const val = rec ? rec.score : 0;
      const h = max > 0 ? (val/max*100) : 0; const barHeight = Math.max(h, 1); 
      chart.innerHTML += `<div style="flex:1; height:100%; display:flex; flex-direction:column; justify-content:flex-end; align-items:center;">
            <span style="font-size:9px; color:var(--text-main); margin-bottom:1px; ${val>0?'':'opacity:0'}">${val}</span>
            <div style="width:100%; background:var(--productivity); height:${barHeight}%; border-radius:4px 4px 0 0; opacity:${val>0?1:0.2}"></div></div>`;
      labels.innerHTML += `<div style="flex:1; text-align:center">${idx}</div>`;
    });
  }

  function updateGauge(prefix, percent, reason="", rColor="") {
      const maxDash = 251; const arc = $(`${prefix}_gauge_arc`); const needle = $(`${prefix}_gauge_needle`); const text = $(`${prefix}_gauge_text`);
      const rDiv = $(`${prefix}_gauge_reason`); if(rDiv && reason) { rDiv.textContent = reason; rDiv.style.color = rColor; }
      let color = "#10b981"; 
      if(percent < 50) color = "#ef4444"; 
      else if(percent < 85) color = "#f59e0b"; 
      
      arc.style.strokeDasharray = `${(percent/100)*251}, 251`; arc.style.stroke = color;
      const deg = -90 + (percent * 1.8); needle.style.transform = `rotate(${deg}deg)`; text.textContent = Math.round(percent) + "%"; text.style.fill = color;
  }

  async function loadGeneralStats(){
    const from = $('st_from').value, to = $('st_to').value;
    const h = $('st_hall').value, s = $('st_shift').value, t = $('st_type').value;
    const curYear = new Date(from).getFullYear();
    
    let qProd = sb.from('monthly_stats').select('employee_id, score, employees!inner(name, hall, shift, hall_type, rank)').eq('year', curYear);
    if(h) qProd = qProd.eq('employees.hall', h); 
    if(s) qProd = qProd.eq('employees.shift', s);
    if(t) qProd = qProd.eq('employees.hall_type', t);

    const {data: prodData} = await qProd;
    const empProdMap = {}; let totalSysProd = 0;
    
    const disciplineScores = {}; 
    const violationMap = {};
    const absenceMap = {};

    if(prodData) prodData.forEach(row => {
      const eid = row.employee_id;
      if(!empProdMap[eid]) empProdMap[eid] = { 
          name:row.employees.name, hall:row.employees.hall, shift:row.employees.shift, rank:row.employees.rank,
          total:0 
      };
      empProdMap[eid].total += row.score; 
      totalSysProd += row.score;
      
      if(!disciplineScores[eid]) disciplineScores[eid] = { 
          ...empProdMap[eid], points: 0, days: 0, 
          prodTotal: row.score, 
          earlyCount: 0, vioCount: 0, lateCount: 0 
      };
      else disciplineScores[eid].prodTotal = row.score;
    });

    const sortedProd = Object.values(empProdMap).sort((a,b) => b.total - a.total);
    const chartDiv = $('prod_leaderboard'); chartDiv.innerHTML = ''; const maxVal = sortedProd[0]?.total || 0;
    sortedProd.slice(0, 10).forEach((e, i) => {
       const pct = maxVal > 0 ? (e.total/maxVal*100) : 0;
       chartDiv.innerHTML += `<div class="bar-row"><div style="font-size:13px; white-space:nowrap; overflow:hidden;">${i+1}. ${e.name} <span class="emp-meta">${e.hall}-${e.shift}</span></div>
            <div class="bar-track"><div class="bar-fill rank-1" style="width:${pct}%"></div></div><div style="font-weight:bold; color:var(--productivity)">${e.total}</div></div>`;
    });
    $('g_total_prod').textContent = totalSysProd;

    let qEv = sb.from('events').select('status, event_date, note, employees!inner(id, name, hall, shift, hall_type, rank)').gte('event_date', from).lte('event_date', to);
    if(h) qEv = qEv.eq('employees.hall', h); 
    if(s) qEv = qEv.eq('employees.shift', s);
    if(t) qEv = qEv.eq('employees.hall_type', t);

    const {data: events} = await qEv;
    const statsEvents = events || [];
    const statusCounts = {}; const hallViolations = {}; const hallAbsent = {}; const hallDiscipline = {}; 
    let totalBadEvents = 0;
    let grandTotalPoints = 0;
    let grandTotalDays = 0;
    
    const timelineData = {};

    statsEvents.forEach(ev => {
       statusCounts[ev.status] = (statusCounts[ev.status]||0)+1;
       const key = `ØµØ§Ù„Ø© ${ev.employees.hall} - Ù…Ù†Ø§ÙˆØ¨Ø© ${ev.employees.shift}`;
       const type = STATUSES[ev.status]?.type || 'neutral';
       
       if(!timelineData[ev.event_date]) timelineData[ev.event_date] = { good: 0, bad: 0, total: 0 };
       timelineData[ev.event_date].total++;
       if(type === 'good' || ev.status === 'normal') timelineData[ev.event_date].good++;
       if(type === 'bad') timelineData[ev.event_date].bad++;

       const eid = ev.employees.id;
       if(!disciplineScores[eid]) disciplineScores[eid] = { 
           name:ev.employees.name, hall:ev.employees.hall, shift:ev.employees.shift, rank:ev.employees.rank, 
           points: 0, days: 0, prodTotal: 0, earlyCount: 0, vioCount: 0, lateCount: 0
       };
       if(!violationMap[eid]) violationMap[eid] = {
           name:ev.employees.name, hall:ev.employees.hall, shift:ev.employees.shift, rank:ev.employees.rank, count: 0
       };
       if(!absenceMap[eid]) absenceMap[eid] = {
           name:ev.employees.name, hall:ev.employees.hall, shift:ev.employees.shift, rank:ev.employees.rank, count: 0
       };

       const pts = calculateScore(ev.status, ev.note);
       if (pts !== null) {
           disciplineScores[eid].points += pts;
           disciplineScores[eid].days++;
           grandTotalPoints += pts;
           grandTotalDays++;
       }

       if(ev.status === 'early') disciplineScores[eid].earlyCount++;
       if(ev.status === 'late') disciplineScores[eid].lateCount++;
       if(ev.status === 'absent') absenceMap[eid].count++;
       
       const isFlagged = (ev.status === 'other' && ev.note && ev.note.includes('[Ù…Ø®Ø§Ù„ÙØ©]'));
       
       if(type === 'bad' || isFlagged) {
           disciplineScores[eid].vioCount++;
           violationMap[eid].count++;
           totalBadEvents++; 
           hallViolations[key] = (hallViolations[key]||0)+1; 
       }
       if(type === 'good') { hallDiscipline[key] = (hallDiscipline[key]||0)+1; }
       if(type === 'good' || ev.status === 'normal') hallDiscipline[key] = (hallDiscipline[key]||0)+1;
       if(ev.status === 'absent') hallAbsent[key] = (hallAbsent[key]||0)+1;
    });

    const rawDiscList = Object.values(disciplineScores).map(e => {
        let rawScore = (e.days * 10) + (e.earlyCount * 5) + ((e.prodTotal || 0) / 25) - (e.vioCount * 40) - (e.lateCount * 15);
        if(rawScore < 0) rawScore = 0;
        return { ...e, rawScore };
    });
    
    let maxRaw = 0;
    rawDiscList.forEach(e => { if(e.rawScore > maxRaw) maxRaw = e.rawScore; });

    const disciplineList = rawDiscList.map(e => {
        let pct = maxRaw > 0 ? (e.rawScore / maxRaw * 100) : 0;
        return { ...e, finalScore: pct };
    }).sort((a,b) => b.finalScore - a.finalScore);

    const discChartDiv = $('discipline_leaderboard'); discChartDiv.innerHTML = ''; 
    
    disciplineList.slice(0, 5).forEach((e, i) => {
       let displayPct = e.finalScore;
       
       let prodText = "Ø¬ÙŠØ¯";
       if(e.prodTotal > 3000) prodText = "Ø±Ø§Ø¦Ø¹Ø© Ø¬Ø¯Ø§Ù‹";
       else if(e.prodTotal >= 1000) prodText = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
       else if(e.prodTotal === 0) prodText = "Ù…Ù†Ø®ÙØ¶";
       
       let details = [];
       if(e.earlyCount > 0) details.push(`Ù…Ø¨ÙƒØ±: ${e.earlyCount}`);
       details.push(`Ø¥Ù†ØªØ§Ø¬ÙŠØ©: ${prodText}`);
       if(e.vioCount > 0) details.push(`Ù…Ø®Ø§Ù„ÙØ§Øª: ${e.vioCount}`);
       
       const detailStr = details.join(' - ');

       discChartDiv.innerHTML += `<div class="bar-row">
            <div style="font-size:12px; line-height:1.2; overflow:hidden;">
                <div style="font-weight:bold">${i+1}. ${e.name}</div>
                <div style="font-size:10px; color:var(--text-muted)">${e.rank} | ${e.hall}-${e.shift}</div>
                <span class="discipline-detail-text">${detailStr}</span>
            </div>
            <div class="bar-track"><div class="bar-fill" style="width:${displayPct}%; background:var(--success)"></div></div>
            <div style="font-weight:bold; color:var(--success); font-size:12px">${Math.round(e.finalScore)}%</div>
       </div>`;
    });

    const violationList = Object.values(violationMap).sort((a,b) => b.count - a.count);
    const vioChartDiv = $('violations_leaderboard'); vioChartDiv.innerHTML = '';
    const maxVioVal = violationList[0]?.count || 0;

    violationList.slice(0, 5).forEach((e, i) => {
        if(e.count === 0) return;
        const pct = (maxVioVal > 0) ? (e.count/maxVioVal*100) : 0;
        vioChartDiv.innerHTML += `<div class="bar-row">
            <div style="font-size:12px; line-height:1.2; overflow:hidden;">
                <div style="font-weight:bold">${i+1}. ${e.name}</div>
            </div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:var(--danger)"></div></div>
            <div style="font-weight:bold; color:var(--danger); font-size:12px">${e.count}</div>
       </div>`;
    });
    if(vioChartDiv.innerHTML === '') vioChartDiv.innerHTML = '<div style="text-align:center; color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª âœ…</div>';

    const absentList = Object.values(absenceMap).sort((a,b) => b.count - a.count);
    const absChartDiv = $('absent_leaderboard'); absChartDiv.innerHTML = '';
    const maxAbsVal = absentList[0]?.count || 0;

    absentList.slice(0, 5).forEach((e, i) => {
        if(e.count === 0) return;
        const pct = (maxAbsVal > 0) ? (e.count/maxAbsVal*100) : 0;
        absChartDiv.innerHTML += `<div class="bar-row">
            <div style="font-size:12px; line-height:1.2; overflow:hidden;">
                <div style="font-weight:bold">${i+1}. ${e.name}</div>
            </div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:var(--danger)"></div></div>
            <div style="font-weight:bold; color:var(--danger); font-size:12px">${e.count}</div>
       </div>`;
    });
    if(absChartDiv.innerHTML === '') absChartDiv.innerHTML = '<div style="text-align:center; color:var(--text-muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ âœ…</div>';

    const timelineContainer = $('timeline_chart');
    timelineContainer.innerHTML = '';
    const allDates = Object.keys(timelineData).sort();
    const sortedDates = allDates.slice(-30); 

    sortedDates.forEach(d => {
        const item = timelineData[d];
        const totalHeight = item.total > 0 ? Math.min(item.total * 5, 100) : 5; 
        const goodHeight = item.total > 0 ? (item.good / item.total * totalHeight) : 0;
        const badHeight = item.total > 0 ? (item.bad / item.total * totalHeight) : 0;
        
        const dateObj = new Date(d);
        const dateStr = `${dateObj.getDate()}/${dateObj.getMonth()+1}`;

        timelineContainer.innerHTML += `
            <div class="timeline-group">
                <div class="timeline-score">${Math.round((item.good/item.total)*100)}%</div>
                <div class="timeline-bars">
                    <div class="t-bar-total" style="height:${totalHeight}px;" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.total}"></div>
                    <div class="t-bar-good" style="height:${goodHeight}px;" title="Ù…Ù†Ø¶Ø¨Ø·: ${item.good}"></div>
                    <div class="t-bar-bad" style="height:${badHeight}px;" title="Ù…Ø®Ø§Ù„Ù: ${item.bad}"></div>
                </div>
                <div class="timeline-label">${dateStr}</div>
            </div>
        `;
    });

    let globalPct = 90;
    let gReason = "", gColor = "";
    if(grandTotalDays < 10) {
        globalPct = 50; gReason = "Ø¹Ø§Ø¯ÙŠ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©"; gColor = "var(--text-muted)";
    } else {
        if(grandTotalDays > 0) {
            globalPct = (grandTotalPoints / (grandTotalDays * 10)) * 100;
            if(totalSysProd > 100) globalPct += 2;
        }
        if(globalPct > 100) globalPct = 100; if(globalPct < 0) globalPct = 0;
        if(globalPct < 50) { gReason = `Ù…Ù†Ø®ÙØ¶`; gColor = "var(--danger)"; } 
        else if (globalPct < 70) { gReason = "Ù…ØªÙˆØ³Ø·"; gColor = "var(--warning)"; } 
        else if (globalPct < 90) { gReason = "Ø¬ÙŠØ¯"; gColor = "#3b82f6"; } 
        else { gReason = "Ù…Ù…ÙŠØ²"; gColor = "var(--success)"; }
    }
    updateGauge('g', globalPct, gReason, gColor);

    let maxVio = 0, mostVioHall = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; for(const [k, v] of Object.entries(hallViolations)){ if(v > maxVio) { maxVio = v; mostVioHall = k; } }
    $('g_most_violations').textContent = mostVioHall; $('g_most_violations_count').textContent = maxVio > 0 ? `${maxVio} Ù…Ø®Ø§Ù„ÙØ©` : '';
    let maxAbs = 0, mostAbsHall = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; for(const [k, v] of Object.entries(hallAbsent)){ if(v > maxAbs) { maxAbs = v; mostAbsHall = k; } }
    $('g_most_absent').textContent = mostAbsHall; $('g_most_absent_count').textContent = maxAbs > 0 ? `${maxAbs} ØºÙŠØ§Ø¨` : '';
    let maxDis = 0, mostDisHall = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; for(const [k, v] of Object.entries(hallDiscipline)){ if(v > maxDis) { maxDis = v; mostDisHall = k; } }
    $('g_most_disciplined').textContent = mostDisHall; $('g_most_disciplined_count').textContent = maxDis > 0 ? `${maxDis} Ø­Ø§Ù„Ø© Ø§Ù†Ø¶Ø¨Ø§Ø·` : '';

    const statDiv = $('status_breakdown'); statDiv.innerHTML = '';
    for(const [k, count] of Object.entries(statusCounts)){
      const def = STATUSES[k] || {label:k, color:'#fff'}; 
      const people = statsEvents.filter(x => x.status === k);
      let detailsHtml = '';
      people.forEach(p => {
          detailsHtml += `<div class="detail-row"><span>${p.employees.name}</span><span style="color:var(--text-muted)">${p.employees.hall}-${p.employees.shift} | ${p.event_date}</span></div>`;
      });
      statDiv.innerHTML += `<div class="breakdown-item" onclick="toggleDetails('${k}')"><div style="display:flex; justify-content:space-between; align-items:center"><span style="color:${def.color}">â–  ${def.label}</span><span style="font-weight:bold">${count}</span></div></div><div id="details-${k}" class="breakdown-details">${detailsHtml}</div>`;
    }
  }

  function toggleDetails(statusKey){
      const el = $(`details-${statusKey}`);
      if(el.style.display === 'block') el.style.display = 'none';
      else el.style.display = 'block';
  }

  async function moveEmployee(){
    if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
    const id=$('m_emp').value, h=$('m_new_hall').value, s=$('m_new_shift').value, t=$('m_new_type').value;
    if(!id) return;
    
    const updates = { hall: h, shift: s };
    if(t) updates.hall_type = t;

    const {error} = await sb.from('employees').update(updates).eq('id',id);
    if(error) { $('moveMsg').textContent = 'Ø®Ø·Ø£: ' + error.message; } 
    else { $('moveMsg').textContent = 'ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…'; loadEmployees(); }
  }

  async function addNewEmployeeManual() {
      if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
      const name = $('add_name').value;
      const rank = $('add_rank').value;
      const hall = $('add_hall').value;
      const shift = $('add_shift').value;
      const type = $('add_type').value;

      if(!name || !rank) return alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±ØªØ¨Ø©');

      const fakeId = crypto.randomUUID();

      const { error } = await sb.from('employees').insert({
          id: fakeId,
          name: name,
          rank: rank,
          hall: hall,
          shift: shift,
          hall_type: type,
          is_approved: true, 
          email: null 
      });

      if(error) alert('Ø®Ø·Ø£: ' + error.message);
      else { 
          alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…'); 
          $('add_name').value = ''; 
          loadEmployees(); 
      }
  }

  async function deleteEmployeeManual() {
      if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
      const id = $('del_emp_select').value;
      if(!id) return;

      if(!confirm('ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…: Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¯ ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

      const { error } = await sb.from('employees').delete().eq('id', id);
      if(error) alert('Ø®Ø·Ø£: ' + error.message);
      else {
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸');
          loadEmployees();
      }
  }

  function filterEditSelect(){
      const txt = $('e_search').value.toLowerCase(); const el = $('e_emp_select'); el.innerHTML = '';
      const filtered = employees.filter(e => e.name.toLowerCase().includes(txt));
      filtered.forEach(e => el.innerHTML += `<option value="${e.id}">${e.name} (${e.hall}-${e.shift})</option>`);
      if(filtered.length) el.selectedIndex = 0;
  }
  
  function filterMoveSelect(){
      const txt = $('search_move_emp').value.toLowerCase(); const el = $('m_emp'); el.innerHTML = '';
      const filtered = employees.filter(e => e.name.toLowerCase().includes(txt));
      filtered.forEach(e => el.innerHTML += `<option value="${e.id}">${e.name} (${e.hall}-${e.shift})</option>`);
      if(filtered.length) el.selectedIndex = 0;
  }

  function filterDeleteSelect(){
      const txt = $('search_del_emp').value.toLowerCase(); const el = $('del_emp_select'); el.innerHTML = '';
      const filtered = employees.filter(e => e.name.toLowerCase().includes(txt));
      filtered.forEach(e => el.innerHTML += `<option value="${e.id}">${e.name} (${e.hall}-${e.shift})</option>`);
      if(filtered.length) el.selectedIndex = 0;
  }

  async function fetchStatForEdit(){
      const eid = $('e_emp_select').value; const y = $('e_year').value, m = $('e_month').value;
      if(!eid) return; $('editMsg').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
      const {data} = await sb.from('monthly_stats').select('score').eq('employee_id', eid).eq('year', y).eq('month', m).single();
      $('editStatArea').classList.remove('hidden'); $('e_score_val').value = data ? data.score : 0; $('editMsg').textContent = '';
  }
  async function updateStat(){
      if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
      const eid = $('e_emp_select').value; const y = $('e_year').value, m = $('e_month').value; const val = $('e_score_val').value;
      const {error} = await sb.from('monthly_stats').upsert({employee_id: eid, year: y, month: m, score: parseInt(val)}, {onConflict:'employee_id,year,month'});
      $('editMsg').textContent = error ? 'Ø®Ø·Ø£' : 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…';
  }
  async function deleteStat(){
      if (!isAdmin) { alert('â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.'); return; }
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      const eid = $('e_emp_select').value; const y = $('e_year').value, m = $('e_month').value;
      const {error} = await sb.from('monthly_stats').delete().eq('employee_id', eid).eq('year', y).eq('month', m);
      $('editMsg').textContent = error ? 'Ø®Ø·Ø£' : 'ØªÙ… Ø§Ù„Ø­Ø°Ù ğŸ—‘ï¸'; if(!error) $('e_score_val').value = 0;
  }
</script>
</body>
</html>