<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>توزيع الكاونترات - نسخة جوال احترافية</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#1f3a5f;
      --primary2:#2c3e50;
      --accent:#f1c40f;
      --bg:#f4f7fb;
      --line:#e5e7eb;
      --muted:#6b7280;
      --success:#16a34a;
      --danger:#dc2626;
      --warn:#d97706;
      --violet:#7c3aed;
      --teal:#0f766e;
      --font:'Tajawal',sans-serif;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0; background:var(--bg); color:#111827;
      font-family:var(--font); padding-bottom:70px;
    }

    .app-header{
      position:sticky; top:0; z-index:1000;
      background:linear-gradient(135deg,var(--primary2),#35577a);
      color:#fff; padding:8px; box-shadow:0 6px 14px rgba(0,0,0,.16);
    }
    .header-top{ display:flex; align-items:center; justify-content:space-between; gap:6px; margin-bottom:8px; }
    .app-title{ margin:0; font-size:.95rem; font-weight:800; }
    .header-actions{ display:flex; gap:6px; align-items:center; }
    .icon-btn{
      border:none; border-radius:9px; padding:7px 9px; min-height:34px; min-width:34px;
      font-family:var(--font); font-size:.78rem; font-weight:800; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.18);
    }
    .btn-pdf{ background:var(--accent); color:#1f2937; border:none; }

    .top-controls{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:8px; }
    .field{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .field label{ font-size:.72rem; font-weight:700; color:rgba(255,255,255,.92); line-height:1; }
    .field select, .field input{
      width:100%; height:36px; border-radius:9px; border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.12); color:#fff; padding:0 10px; font-family:var(--font);
      font-size:.83rem; outline:none;
    }
    .field select option{color:#111;background:#fff}
    .field input::placeholder{color:rgba(255,255,255,.75)}

    /* المعاينة السريعة */
    .quick-preview-wrap{ background:rgba(255,255,255,.94); border:1px solid #e7ebf1; border-radius:12px; padding:7px; margin:8px; }
    .quick-preview-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; color:#334155; font-size:.74rem; font-weight:800; }
    .quick-preview-grid{ display:flex; gap:6px; overflow-x:auto; padding-bottom:2px; scrollbar-width: none; }
    .quick-preview-grid::-webkit-scrollbar { display: none; }
    .mini-counter-card{
      flex:0 0 140px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px; min-height:46px;
      display:flex; flex-direction:column; justify-content:center;
    }
    .mini-counter-title{ font-size:.7rem; font-weight:800; color:var(--primary); }
    .mini-counter-names{ font-size:.66rem; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* شريط الكاونترات */
    .counter-strip{ background:#fff; border:1px solid #e7ebf1; border-radius:12px; padding:8px; margin:0 8px 8px; }
    .strip-title{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-size:.75rem; font-weight:800; color:#334155; }
    .counter-scroll{ display:flex; gap:6px; overflow-x:auto; padding-bottom:4px; scrollbar-width: none; }
    .counter-scroll::-webkit-scrollbar { display: none; }
    
    .cnt-btn{
      flex:0 0 36px; width:36px; height:36px; border-radius:9px; border:1.8px solid #dbe2ea;
      background:#f8fafc; color:var(--primary2); font-size:.85rem; font-weight:800;
      display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.15s ease; white-space:nowrap;
    }
    .task-cnt-btn { width: auto !important; padding: 0 12px; font-size: 0.78rem; flex-basis: auto; }
    
    .cnt-btn.filled {
      background: rgba(22, 163, 74, 0.15) !important;
      border-color: rgba(22, 163, 74, 0.4) !important;
      color: #15803d !important;
    }
    .cnt-btn.active { background:var(--primary) !important; color:#fff !important; border-color:var(--primary) !important; }
    .cnt-btn.add-task-btn { background:var(--violet); color:#fff; border-color:var(--violet); }

    /* التوزيع والقوائم */
    .transfer-area { display: flex; gap: 8px; margin: 0 8px 8px; }
    .list-panel {
      flex: 1; display: flex; flex-direction: column; background: #fff;
      border: 1px solid var(--line); border-radius: 12px; overflow: hidden; height: 350px;
    }
    .panel-header {
      background: #f8fafc; padding: 8px 10px; font-weight: 800; font-size: 0.75rem;
      color: var(--primary2); border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center;
    }
    .search-row { display:grid; grid-template-columns:1fr auto auto; gap:6px; padding:6px; background:#f8fafc; border-bottom:1px solid var(--line); }
    .search-input { width: 100%; border:1px solid #dbe2ea; border-radius:6px; padding:6px; font-family: var(--font); font-size: 0.75rem; outline: none; }
    
    .mini-action { border:none; border-radius:6px; padding:0 8px; font-family:var(--font); font-weight:800; font-size:.7rem; cursor:pointer; }
    .mini-green { background:var(--success); color:#fff; }
    
    .list-box { flex: 1; overflow-y: auto; padding: 6px; display: flex; flex-direction: column; gap: 4px; background: #fcfcfc; }
    .list-item {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;
      font-size: 0.75rem; font-weight: 700; color: #1e293b; cursor: pointer; display: flex; flex-direction: column; gap: 4px; transition: .1s;
    }
    .list-item:active { transform: scale(0.98); }
    .list-item.selected { border-color: var(--success); background: #f0fdf4; }
    .emp-meta { font-size: 0.65rem; color: var(--muted); }
    .task-badge { font-size: 0.65rem; background: var(--primary); color: #fff; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }
    .task-badge.absent-badge { background: var(--danger); }

    .current-target-banner {
      background: #eef2ff; border: 1px solid #c7d2fe; color: #4338ca; padding: 8px 12px;
      margin: 0 8px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 800; text-align: center; transition: 0.2s;
    }

    /* ===== PDF ===== */
    #pdf-report{ display:none; background:#fff; color:#000; font-family:'Tajawal',sans-serif; padding:18px; direction:rtl; }
    .pdf-header{ display:flex; flex-direction:row-reverse; justify-content:space-between; align-items:flex-start; gap:12px; border-bottom:3px solid #2c3e50; padding-bottom:10px; margin-bottom:12px; }
    .pdf-title{font-size:22px;font-weight:800;color:#2c3e50;margin:0 0 4px 0}
    .pdf-date{font-size:13px;font-weight:700;color:#555}
    .pdf-meta-box{ background:#f8fafc; border:1px solid #dbe2ea; border-radius:8px; padding:8px 10px; font-size:12px; min-width:185px; line-height:1.7; text-align:right; }
    .pdf-section-head{ background:#34495e; color:#fff; padding:6px; font-size:12px; font-weight:800; text-align:center; border-radius:4px 4px 0 0; margin-top:0; }
    .pdf-table,.pdf-extra-table{ width:100%; border-collapse:collapse; font-size:11px; margin-bottom:10px; border:1px solid #bdc3c7; table-layout:fixed; }
    .pdf-table th,.pdf-table td,.pdf-extra-table th,.pdf-extra-table td{ border:1px solid #bdc3c7; padding:6px 6px; vertical-align:middle; }
    .pdf-table th,.pdf-extra-table th{ background:#2c3e50; color:#fff; font-weight:800; text-align:center; font-size:12px; }
    .pdf-table tr:nth-child(even), .pdf-extra-table tr:nth-child(even){background:#f9f9f9}
    .pdf-extra-label{background:#ecf0f1;font-weight:800;width:25%;color:#2c3e50;text-align:center}
    .pdf-horizontal-counters td.row-label{ background:#ecf0f1; font-weight:800; color:#2c3e50; width:110px; text-align:center; white-space:nowrap; }
    .pdf-horizontal-counters td.counter-head{ text-align:center; font-weight:800; background:#f8fafc; }
    .pdf-horizontal-counters td.name-cell{ text-align:center; font-weight:700; word-break:break-word; line-height:1.25; }
  </style>
</head>
<body>
  <div id="appHeader" class="app-header">
    <div class="header-top">
      <h1 class="app-title">توزيع الكاونترات</h1>
      <div class="header-actions">
        <button class="icon-btn" onclick="resetSchedule()" title="تصفير التوزيع">↻</button>
        <button class="icon-btn btn-pdf" onclick="downloadPDF()" title="طباعة PDF">PDF</button>
      </div>
    </div>

    <div class="top-controls">
      <div class="field">
        <label>الصالة</label>
        <select id="hallSelect" onchange="onFilterChange()">
          <option value="">اختر</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="field">
        <label>المناوبة</label>
        <select id="shiftSelect" onchange="onFilterChange()">
          <option value="">اختر</option>
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
          <option value="د">د</option>
        </select>
      </div>
      <div class="field">
        <label>عدد القوة</label>
        <input id="forceCountInput" type="number" min="0" placeholder="تلقائي" oninput="savePrefs()" />
      </div>
    </div>
  </div>

  <div class="counter-strip">
    <div class="strip-title">
      <span>1. اختر الكاونتر أو المهمة للتوزيع عليها</span>
    </div>
    <div class="counter-scroll" id="counterContainer">
        </div>
  </div>

  <div class="current-target-banner" id="currentTargetBanner">
      الهدف الحالي: (الرجاء التحديد من الشريط الأعلى)
  </div>

  <div class="transfer-area">
    <div class="list-panel">
      <div class="panel-header">
          <span>المتاح</span>
          <span style="background:var(--primary); color:#fff; padding:2px 6px; border-radius:10px;" id="c-pool">0</span>
      </div>
      <div class="search-row">
        <input type="text" id="searchPool" class="search-input" placeholder="بحث..." onkeyup="renderTransferLists()">
        <button class="mini-action mini-green" onclick="addNewName()">+ اسم</button>
      </div>
      <div class="list-box" id="list-pool"></div>
    </div>

    <div class="list-panel" style="border-color:var(--success)">
      <div class="panel-header" style="color:var(--success)">
          <span>تم التوزيع</span>
          <span style="background:var(--success); color:#fff; padding:2px 6px; border-radius:10px;" id="c-chosen">0</span>
      </div>
      <div class="search-row">
          <span style="font-size:0.65rem; color:var(--muted); padding:6px">انقر على الاسم للتراجع</span>
      </div>
      <div class="list-box" id="list-chosen"></div>
    </div>
  </div>

  <div class="quick-preview-wrap">
    <div class="quick-preview-head">
      <span>2. المعاينة السريعة</span>
      <span id="quickPreviewCount" style="color:var(--muted)">0</span>
    </div>
    <div id="quickPreviewGrid" class="quick-preview-grid"></div>
  </div>

  <div id="pdf-report">
    <div class="pdf-header">
      <div class="pdf-header-left">
        <div class="pdf-title">جدول توزيع الكاونترات</div>
        <div class="pdf-date" id="pdfDateStr"></div>
      </div>
      <div class="pdf-meta-box" id="pdfFilterInfo"></div>
    </div>
    <div class="pdf-section-head">جدول الكاونترات</div>
    <table class="pdf-table pdf-horizontal-counters">
      <tbody id="pdf-counters-horizontal-body"></tbody>
    </table>
    <div class="pdf-section-head" style="margin-top:12px; background:#2c3e50;">المهام الإضافية</div>
    <table class="pdf-extra-table">
      <thead><tr><th width="30%">المهمة</th><th width="70%">الأسماء</th></tr></thead>
      <tbody id="pdf-tasks-body"></tbody>
    </table>
  </div>

  <script>
    const PREFS_KEY = 'official_sched_mobile_v12_transfer';
    const DEFAULT_TASKS = ["إرشاد", "خدمة ذاتية", "بوابة", "بدون مهام/غياب"];
    
    let employeesData = {}; 
    let savedCustomNames = [];
    let customTasksList = [];
    
    let employees = []; 
    let dailyPool = []; 
    let chosen = [];    
    
    let currentTask = null; 
    let selectedCountersForMerge = [];

    window.onload = () => {
        loadDataAndInitialize();
    };

    async function loadDataAndInitialize() {
        try {
            const response = await fetch('name.json');
            if (!response.ok) throw new Error("لم يتم العثور على الملف");
            employeesData = await response.json();
        } catch (error) {
            console.error(error);
            alert("تعذر تحميل ملف الأسماء (name.json). تأكد من وجوده واستخدامك لخادم محلي (Localhost).");
        }
        
        loadPrefs();
        generateEmployees();
        renderCounterStrip();
        onFilterChange();
    }

    function loadPrefs() {
        try {
            const raw = localStorage.getItem(PREFS_KEY);
            if (raw) {
                const p = JSON.parse(raw);
                if(p.hall) document.getElementById('hallSelect').value = p.hall;
                if(p.shift) document.getElementById('shiftSelect').value = p.shift;
                if(p.force) document.getElementById('forceCountInput').value = p.force;
                if(p.chosen) chosen = p.chosen;
                if(p.savedCustomNames) savedCustomNames = p.savedCustomNames;
                if(p.customTasksList) customTasksList = p.customTasksList;
            }
        } catch(e){}
    }

    function savePrefs() {
        const p = {
            hall: document.getElementById('hallSelect').value,
            shift: document.getElementById('shiftSelect').value,
            force: document.getElementById('forceCountInput').value,
            chosen: chosen,
            savedCustomNames: savedCustomNames,
            customTasksList: customTasksList
        };
        localStorage.setItem(PREFS_KEY, JSON.stringify(p));
    }

    function generateEmployees() {
        employees = [];
        if (!employeesData) return;
        for (const shift in employeesData) {
            for (const hall in employeesData[shift]) {
                const staffList = employeesData[shift][hall];
                staffList.forEach((p, idx) => {
                    employees.push({
                        id: p.id || `emp_${shift}_${hall}_${idx}`,
                        name: p.name,
                        rank: p.rank || 'غير محدد',
                        hall: hall,
                        shift: shift
                    });
                });
            }
        }
    }

    function addNewName() {
        const name = prompt("أدخل الاسم الجديد لإضافته للقائمة:");
        if (name && name.trim() !== '') {
            savedCustomNames.push(name.trim());
            savePrefs();
            onFilterChange(); 
        }
    }

    function addNewTask() {
        const t = prompt("أدخل اسم المهمة الجديدة:");
        if (t && t.trim() !== '') {
            if(!customTasksList.includes(t.trim()) && !DEFAULT_TASKS.includes(t.trim())) {
                customTasksList.push(t.trim());
                savePrefs();
                renderCounterStrip();
            } else {
                alert("هذه المهمة موجودة مسبقاً.");
            }
        }
    }

    function onFilterChange() {
        const h = document.getElementById('hallSelect').value;
        const s = document.getElementById('shiftSelect').value;

        if (!h || !s) {
            dailyPool = [];
            document.getElementById('forceCountInput').value = '';
        } else {
            const chosenIds = chosen.map(x => x.id);
            dailyPool = employees.filter(e => e.hall === h && e.shift === s && !chosenIds.includes(e.id));
            
            savedCustomNames.forEach((n, i) => {
                const cId = 'custom_name_' + i;
                if (!chosenIds.includes(cId)) {
                    dailyPool.push({ id: cId, name: n, rank: 'إضافي', hall: h, shift: s });
                }
            });

            dailyPool.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            const chosenForThisShift = chosen.filter(e => e.hall === h && e.shift === s).length;
            const totalForce = dailyPool.length + chosenForThisShift;
            document.getElementById('forceCountInput').value = totalForce;
        }
        
        savePrefs();
        renderTransferLists();
    }

    function renderCounterStrip() {
        const container = document.getElementById('counterContainer');
        container.innerHTML = '';

        for (let i = 1; i <= 20; i++) {
            const isFilled = chosen.some(x => x.task === `كاونتر ${i}` || x.task.startsWith(`كاونتر ${i} &`) || x.task.endsWith(`& ${i}`));
            
            const div = document.createElement('div');
            div.className = `cnt-btn ${selectedCountersForMerge.includes(i) ? 'active' : ''} ${isFilled ? 'filled' : ''}`;
            div.textContent = i;
            div.onclick = () => selectCounterNumber(i);
            container.appendChild(div);
        }

        const allTasks = [...DEFAULT_TASKS, ...customTasksList];
        allTasks.forEach(t => {
            const isFilled = chosen.some(x => x.task === t);
            const div = document.createElement('div');
            div.className = `cnt-btn task-cnt-btn ${currentTask === t ? 'active' : ''} ${isFilled ? 'filled' : ''}`;
            div.textContent = t;
            div.onclick = () => selectTask(t);
            container.appendChild(div);
        });

        const btnAddTask = document.createElement('div');
        btnAddTask.className = `cnt-btn task-cnt-btn add-task-btn`;
        btnAddTask.textContent = '+ مهمة';
        btnAddTask.onclick = addNewTask;
        container.appendChild(btnAddTask);

        updateCurrentTargetBanner();
    }

    function selectCounterNumber(num) {
        if (currentTask && isNaN(parseInt(currentTask.replace('كاونتر ', '')))) {
             currentTask = null;
             selectedCountersForMerge = [];
        }

        if (selectedCountersForMerge.includes(num)) {
            selectedCountersForMerge = selectedCountersForMerge.filter(n => n !== num);
        } else {
            if (selectedCountersForMerge.length >= 2) selectedCountersForMerge.shift();
            selectedCountersForMerge.push(num);
        }

        if (selectedCountersForMerge.length === 1) {
            currentTask = `كاونتر ${selectedCountersForMerge[0]}`;
        } else if (selectedCountersForMerge.length === 2) {
            const sorted = [...selectedCountersForMerge].sort((a,b)=>a-b);
            currentTask = `كاونتر ${sorted[0]} & ${sorted[1]}`;
        } else {
             currentTask = null;
        }

        renderCounterStrip();
    }

    function selectTask(taskName) {
        selectedCountersForMerge = []; 
        currentTask = taskName;
        renderCounterStrip();
    }

    function updateCurrentTargetBanner() {
        const banner = document.getElementById('currentTargetBanner');
        if (!currentTask) {
            banner.style.background = '#fef2f2';
            banner.style.color = '#991b1b';
            banner.style.borderColor = '#fecaca';
            banner.textContent = 'يرجى اختيار كاونتر أو مهمة من الشريط الأعلى أولاً';
        } else {
            banner.style.background = '#eef2ff';
            banner.style.color = '#4338ca';
            banner.style.borderColor = '#c7d2fe';
            
            if (selectedCountersForMerge.length === 2) {
                banner.textContent = `سيتم دمج الكونترين: ${currentTask} (اختر اسماً من المتاح للتوزيع)`;
            } else {
                banner.textContent = `الهدف الحالي: ${currentTask} (اختر اسماً من المتاح للتوزيع)`;
            }
        }
    }

    // تنسيق الاسم للقائمة (الأول، الثاني، الأخير)
    function formatShortName(fullName) {
        if (!fullName) return '';
        const parts = fullName.trim().split(/\s+/);
        if (parts.length >= 4) {
            return `${parts[0]} ${parts[1]} ${parts[parts.length - 1]}`;
        }
        return fullName;
    }

    // تنسيق الاسم للمعاينة السريعة (الأول والأخير فقط)
    function formatFirstAndLastName(fullName) {
        if (!fullName) return '';
        const parts = fullName.trim().split(/\s+/);
        if (parts.length > 1) {
            return `${parts[0]} ${parts[parts.length - 1]}`;
        }
        return fullName;
    }

    function renderTransferLists() {
        const pList = document.getElementById('list-pool');
        const cList = document.getElementById('list-chosen');
        const searchTxt = document.getElementById('searchPool').value.toLowerCase();
        
        pList.innerHTML = ''; cList.innerHTML = '';

        const avail = dailyPool.filter(e => e.name.toLowerCase().includes(searchTxt));
        
        document.getElementById('c-pool').textContent = avail.length;
        document.getElementById('c-chosen').textContent = chosen.length;

        if (avail.length === 0) {
            pList.innerHTML = `<div style="text-align:center; color:#94a3b8; font-size:0.75rem; margin-top:20px;">لا يوجد أسماء</div>`;
        } else {
            avail.forEach(e => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<div style="font-weight:800;">${formatShortName(e.name)}</div><div class="emp-meta">${e.rank}</div>`;
                div.onclick = () => assignPerson(e);
                pList.appendChild(div);
            });
        }

        if (chosen.length === 0) {
            cList.innerHTML = `<div style="text-align:center; color:#94a3b8; font-size:0.75rem; margin-top:20px;">لم يتم توزيع أحد</div>`;
        } else {
            const sortedChosen = [...chosen].sort((a,b) => a.task.localeCompare(b.task, 'ar'));
            sortedChosen.forEach((e) => {
                const isAbsent = e.task === "بدون مهام/غياب";
                const div = document.createElement('div');
                div.className = 'list-item selected';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="font-weight:800;">${formatShortName(e.name)}</div>
                        <div class="task-badge ${isAbsent ? 'absent-badge' : ''}">${e.task}</div>
                    </div>
                    <div class="emp-meta" style="margin-top:2px">${e.rank}</div>
                `;
                div.onclick = () => unassignPerson(e.id);
                cList.appendChild(div);
            });
        }

        renderQuickPreview();
        savePrefs();
    }

    // الدالة المعدلة: تلغي التحديد التلقائي عند الوصول لـ 3 وتمنع الرابع
    function assignPerson(emp) {
        if (!currentTask) {
            alert("الرجاء اختيار كاونتر أو مهمة من الأعلى قبل اختيار الاسم.");
            return;
        }

        // حماية إضافية: إذا أعاد المستخدم تحديد كاونتر ممتلئ مسبقاً
        if (currentTask.startsWith('كاونتر')) {
            const currentCount = chosen.filter(x => x.task === currentTask).length;
            if (currentCount >= 3) {
                alert('عذراً، هذا الكاونتر ممتلئ (تم اختيار 3 أفراد مسبقاً).');
                currentTask = null;
                selectedCountersForMerge = [];
                renderCounterStrip();
                return;
            }
        }

        dailyPool = dailyPool.filter(x => x.id !== emp.id);
        chosen.push({ ...emp, task: currentTask });

        // إلغاء التحديد تلقائياً عند الوصول لـ 3 أفراد (للكاونترات الفردية والمدمجة)
        if (currentTask.startsWith('كاونتر')) {
            const newCount = chosen.filter(x => x.task === currentTask).length;
            if (newCount >= 3) {
                currentTask = null;
                selectedCountersForMerge = [];
            }
        }

        renderCounterStrip();
        renderTransferLists();
    }

    function unassignPerson(empId) {
        const empIndex = chosen.findIndex(x => x.id === empId);
        if (empIndex > -1) {
            const emp = chosen[empIndex];
            chosen.splice(empIndex, 1);
            delete emp.task; 
            dailyPool.push(emp);
            dailyPool.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        }
        renderCounterStrip(); 
        renderTransferLists();
    }

    function resetSchedule() {
        if (!confirm('تصفير التوزيع بالكامل؟')) return;
        chosen = [];
        selectedCountersForMerge = [];
        currentTask = null;
        onFilterChange(); 
        renderCounterStrip();
    }

    function generateStructuredData() {
        let cardsMap = {}; 
        let tasksMap = {}; 

        chosen.forEach(p => {
            if (p.task === "بدون مهام/غياب") return; 

            if(p.task.startsWith('كاونتر')) {
                if(!cardsMap[p.task]) {
                    let isMerged = p.task.includes('&');
                    let numsStr = p.task.replace('كاونتر ', '');
                    let nums = isMerged ? numsStr.split('&').map(n=>parseInt(n.trim())) : [parseInt(numsStr.trim())];
                    cardsMap[p.task] = { id: p.task, nums: nums, type: isMerged ? 'merged' : 'single', people: [] };
                }
                cardsMap[p.task].people.push(p);
            } else {
                if(!tasksMap[p.task]) {
                    tasksMap[p.task] = { title: p.task, people: [] };
                }
                tasksMap[p.task].people.push(p);
            }
        });

        return { 
            cards: Object.values(cardsMap).sort((a,b) => a.nums[0] - b.nums[0]), 
            tasks: Object.values(tasksMap) 
        };
    }

    function renderQuickPreview() {
        const grid = document.getElementById('quickPreviewGrid');
        const countSpan = document.getElementById('quickPreviewCount');
        
        const data = generateStructuredData();
        const allItems = [...data.cards, ...data.tasks];
        
        countSpan.textContent = `(${allItems.length} عناصر)`;
        grid.innerHTML = '';

        if(allItems.length === 0) {
            grid.innerHTML = `<div style="width:100%; text-align:center; color:#94a3b8; font-size:0.75rem; padding:10px;">فارغ (الأشخاص بدون مهام/غياب لا يظهرون هنا)</div>`;
            return;
        }

        data.cards.forEach(c => {
            const title = c.type === 'merged' ? `كاونتر ${c.nums[0]} & ${c.nums[1]}` : `كاونتر ${c.nums[0]}`;
            const names = c.people.map(p => formatFirstAndLastName(p.name)).join(' + ');
            grid.innerHTML += `
                <div class="mini-counter-card">
                    <div class="mini-counter-title">${title}</div>
                    <div class="mini-counter-names">${names || 'فارغ'}</div>
                </div>
            `;
        });

        data.tasks.forEach(t => {
            const names = t.people.map(p => formatFirstAndLastName(p.name)).join(' + ');
            grid.innerHTML += `
                <div class="mini-counter-card" style="border-top:2px solid var(--teal)">
                    <div class="mini-counter-title" style="color:var(--teal)">${t.title}</div>
                    <div class="mini-counter-names">${names || 'فارغ'}</div>
                </div>
            `;
        });
    }

    function downloadPDF() {
      if (typeof html2pdf === 'undefined') { alert('مكتبة PDF غير محملة'); return; }
      
      const data = generateStructuredData();
      populatePDF(data);

      const element = document.getElementById('pdf-report');
      element.style.display = 'block';

      const opt = {
        margin: [6, 6, 6, 6],
        filename: `توزيع_المناوبة_${new Date().toISOString().slice(0,10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      html2pdf().set(opt).from(element).save()
        .then(() => { element.style.display = 'none'; })
        .catch(() => { element.style.display = 'none'; });
    }

    function populatePDF(data) {
      const dateEl = document.getElementById('pdfDateStr');
      const infoEl = document.getElementById('pdfFilterInfo');
      const countersBody = document.getElementById('pdf-counters-horizontal-body');
      const tasksBody = document.getElementById('pdf-tasks-body');

      dateEl.innerText = `التاريخ: ${new Date().toLocaleDateString('ar-SA')}`;
      infoEl.innerHTML = `
        <div><strong>الصالة:</strong> ${document.getElementById('hallSelect').value || '-'}</div>
        <div><strong>المناوبة:</strong> ${document.getElementById('shiftSelect').value || '-'}</div>
        <div><strong>عدد القوة:</strong> ${document.getElementById('forceCountInput').value || '-'}</div>
      `;

      countersBody.innerHTML = '';
      tasksBody.innerHTML = '';

      if (data.cards.length === 0) {
        countersBody.innerHTML = `
          <tr><td class="row-label">رقم الكونتر</td><td colspan="10" style="text-align:center;">لا يوجد</td></tr>
          <tr><td class="row-label">الفرد الأول</td><td colspan="10" style="text-align:center;">-</td></tr>
          <tr><td class="row-label">الفرد الثاني</td><td colspan="10" style="text-align:center;">-</td></tr>
          <tr><td class="row-label">فرد التغطية</td><td colspan="10" style="text-align:center;">-</td></tr>
        `;
      } else {
        const trCounters = document.createElement('tr'); trCounters.innerHTML = `<td class="row-label">رقم الكونتر</td>`;
        const trFirst   = document.createElement('tr'); trFirst.innerHTML = `<td class="row-label">الفرد الأول</td>`;
        const trSecond  = document.createElement('tr'); trSecond.innerHTML = `<td class="row-label">الفرد الثاني</td>`;
        const trCover   = document.createElement('tr'); trCover.innerHTML = `<td class="row-label">فرد التغطية</td>`;

        data.cards.forEach(card => {
          if (card.type === 'single') {
            const first = card.people[0] ? formatShortName(card.people[0].name) : '-';
            const second = '-'; 
            const cover = card.people[1] ? formatShortName(card.people[1].name) : '-';

            const tdCounter = document.createElement('td'); tdCounter.className = 'counter-head'; tdCounter.textContent = String(card.nums[0]);
            const tdFirst = document.createElement('td'); tdFirst.className = 'name-cell'; tdFirst.textContent = first;
            const tdSecond = document.createElement('td'); tdSecond.className = 'name-cell'; tdSecond.textContent = second;
            const tdCover = document.createElement('td'); tdCover.className = 'name-cell'; tdCover.textContent = cover;

            trCounters.appendChild(tdCounter); trFirst.appendChild(tdFirst); trSecond.appendChild(tdSecond); trCover.appendChild(tdCover);
          } else {
            const first = card.people[0] ? formatShortName(card.people[0].name) : '-';
            const second = card.people[1] ? formatShortName(card.people[1].name) : '-';
            const cover = card.people[2] ? formatShortName(card.people[2].name) : '-';

            const tdCounter1 = document.createElement('td'); tdCounter1.className = 'counter-head'; tdCounter1.textContent = String(card.nums[0]);
            const tdCounter2 = document.createElement('td'); tdCounter2.className = 'counter-head'; tdCounter2.textContent = String(card.nums[1]);

            trCounters.appendChild(tdCounter1); trCounters.appendChild(tdCounter2);

            const tdFirst = document.createElement('td'); tdFirst.className = 'name-cell'; tdFirst.colSpan = 2; tdFirst.textContent = first;
            const tdSecond = document.createElement('td'); tdSecond.className = 'name-cell'; tdSecond.colSpan = 2; tdSecond.textContent = second;
            const tdCover = document.createElement('td'); tdCover.className = 'name-cell'; tdCover.colSpan = 2; tdCover.textContent = cover;

            trFirst.appendChild(tdFirst); trSecond.appendChild(tdSecond); trCover.appendChild(tdCover);
          }
        });

        countersBody.appendChild(trCounters); countersBody.appendChild(trFirst); countersBody.appendChild(trSecond); countersBody.appendChild(trCover);
      }

      if (data.tasks.length === 0) {
        tasksBody.innerHTML = `<tr><td colspan="2" style="text-align:center;">لا توجد مهام إضافية</td></tr>`;
      } else {
        data.tasks.forEach(task => {
          const namesHtml = task.people.map(p => `<div>${formatShortName(p.name)}</div>`).join('');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="pdf-extra-label">${task.title}</td>
            <td class="name-cell" style="text-align:right; padding-right:15px;">${namesHtml || '-'}</td>
          `;
          tasksBody.appendChild(tr);
        });
      }
    }
  </script>
</body>
</html>